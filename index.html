<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CVS PHANToM ‚Äî Map + List (Mint Light)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6fffb;
      --card:#ffffff;
      --line:#d7efe7;
      --text:#0b1b16;
      --muted:#49665c;
      --mint:#46d7b5;
      --mint2:#22bfa0;
      --mint3:#0aa384;
      --danger:#ff5d5d;
      --shadow: 0 10px 26px rgba(14, 45, 35, .10);
      --shadow2: 0 6px 18px rgba(14, 45, 35, .10);
      --r:18px;
      --r2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans Thai", "Prompt", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      overflow:hidden; /* ‡∏Å‡∏±‡∏ô scroll ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    /* Top bar */
    .topbar{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px 10px 12px;
      z-index:5;
    }
    .burger{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:var(--shadow2);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition:.15s;
    }
    .burger:active{transform:scale(.98)}
    .burger .i{
      width:18px;height:14px;position:relative;
    }
    .burger .i:before,.burger .i:after,.burger .i div{
      content:"";
      position:absolute;left:0;right:0;
      height:2px;border-radius:2px;background:var(--mint3);
    }
    .burger .i:before{top:0}
    .burger .i div{top:6px}
    .burger .i:after{bottom:0}
    .titlebox{
      flex:1;
      min-width:0;
    }
    .title{
      font-size:14px;
      font-weight:800;
      line-height:1.05;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow2);
      font-size:12px;
      font-weight:700;
      color:var(--mint3);
      display:flex;align-items:center;gap:8px;
      cursor:pointer;
    }
    .pill .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--mint2);
      box-shadow:0 0 0 4px rgba(34,191,160,.16);
    }

    /* Main split */
    .main{
      flex:1;
      display:flex;
      min-height:0; /* allow children to scroll */
    }

    /* List panel */
    .panel{
      width:420px;
      max-width:92vw;
      padding:0 12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:3;
    }

    .search{
      border-radius:var(--r);
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:var(--shadow2);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .input{
      flex:1;
      height:42px;
      border-radius:14px;
      border:1px solid var(--line);
      padding:0 12px;
      outline:none;
      font-size:13px;
      background:#fbfffd;
    }
    .btn{
      height:42px;
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(70,215,181,.18), rgba(70,215,181,.06));
      color:var(--mint3);
      font-weight:800;
      padding:0 12px;
      cursor:pointer;
      transition:.15s;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btn.secondary{
      background:var(--card);
      color:var(--muted);
    }
    .filters{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      user-select:none;
    }
    .chip.on{
      background:rgba(70,215,181,.18);
      color:var(--mint3);
      border-color:rgba(34,191,160,.35);
    }

    .list{
      flex:1;
      min-height:0;
      border-radius:var(--r);
      border:1px solid var(--line);
      background:rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      overflow:auto;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* card */
    .card{
      border-radius:var(--r);
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:var(--shadow2);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .cardHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .cTitle{
      font-weight:900;
      font-size:13px;
      line-height:1.15;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .badge{
      font-size:11px;
      font-weight:900;
      color:#0b1b16;
      background:rgba(70,215,181,.22);
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(34,191,160,.35);
    }
    .mini{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cMeta{
      display:grid;
      grid-template-columns: 1fr;
      gap:3px;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .act{
      height:36px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(70,215,181,.18), rgba(70,215,181,.04));
      color:var(--mint3);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }
    .act.secondary{
      background:var(--card);
      color:var(--muted);
      font-weight:800;
    }
    .act:active{transform:scale(.98)}
    .pin{
      width:36px;
      justify-content:center;
      padding:0;
    }
    .pin.on{
      background:rgba(255, 214, 102, .25);
      color:#8a6300;
      border-color:rgba(255, 214, 102, .55);
    }

    /* Map */
    .mapWrap{
      flex:1;
      min-width:0;
      padding:0 12px 12px 0;
      position:relative;
      z-index:1;
    }
    #map{
      height:100%;
      border-radius:22px;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      overflow:hidden;
      background:#e9fff7;
    }

    /* Sidebar overlay */
    .sbOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.26);
      opacity:0;
      pointer-events:none;
      transition:.18s;
      z-index:20;
    }
    .sbOverlay.on{
      opacity:1;
      pointer-events:auto;
    }
    .sidebar{
      position:fixed;
      top:0;left:0;bottom:0;
      width:320px;
      max-width:86vw;
      background:rgba(255,255,255,.88);
      backdrop-filter: blur(12px);
      border-right:1px solid var(--line);
      box-shadow: 20px 0 40px rgba(0,0,0,.12);
      transform:translateX(-102%);
      transition:.18s;
      z-index:21;
      display:flex;
      flex-direction:column;
    }
    .sidebar.on{transform:translateX(0)}
    .sbTop{
      padding:16px 14px 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .sbBrand{
      display:flex;flex-direction:column;gap:2px;
      min-width:0;
    }
    .sbBrand b{
      font-size:14px;
      letter-spacing:.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sbBrand span{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sbClose{
      width:42px;height:42px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      cursor:pointer;
      box-shadow:var(--shadow2);
      font-weight:900;
      color:var(--muted);
    }
    .sbBody{
      padding:12px 14px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sbGroup{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.7);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sbGroup h4{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.2px;
    }
    .sbLink{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-weight:900;
      color:var(--text);
    }
    .sbLink small{color:var(--muted);font-weight:800}

    /* Report popup overlay */
    .repOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.28);
      z-index:30;
      opacity:0;
      pointer-events:none;
      transition:.18s;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .repOverlay.on{
      opacity:1;
      pointer-events:auto;
    }
    .repBox{
      width:min(980px, 100%);
      height:min(92vh, 820px);
      border-radius:22px;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .repHead{
      padding:12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(246,255,251,.55);
    }
    .repHead .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .repHead .left b{
      font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .repHead .left span{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .repHead .right{
      display:flex;
      gap:8px;
    }
    .repHead .hbtn{
      height:40px;
      padding:0 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-weight:900;
      color:var(--muted);
      display:flex;align-items:center;gap:8px;
      white-space:nowrap;
    }
    .repBody{
      flex:1;
      min-height:0;
      position:relative;
      background:#fff;
    }
    .repFrame{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(11,27,22,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      font-weight:800;
      box-shadow:0 12px 26px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:.16s;
      z-index:40;
      max-width:92vw;
      text-align:center;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .toast.on{opacity:1}

    /* Responsive: stack */
    @media (max-width: 900px){
      .panel{width:360px}
      .mapWrap{padding-right:12px}
      #map{border-radius:20px}
    }
    @media (max-width: 740px){
      .main{flex-direction:column}
      .panel{width:100%;max-width:none}
      .mapWrap{padding:0 12px 12px 12px}
      #map{height:42vh}
      .list{max-height:48vh}
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Topbar -->
  <div class="topbar">
    <div class="burger" id="btnBurger" title="‡πÄ‡∏°‡∏ô‡∏π">
      <div class="i"><div></div></div>
    </div>
    <div class="titlebox">
      <div class="title">CVS PHANToM</div>
      <div class="subtitle" id="subTitle">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ Mint Light</div>
    </div>
    <div class="pill" id="btnLocate" title="‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô">
      <span class="dot"></span>
      <span>Locate</span>
    </div>
  </div>

  <div class="main">
    <!-- Left panel -->
    <div class="panel">

      <div class="search">
        <div class="row">
          <input class="input" id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / ‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤ / account / zone ‚Ä¶">
          <button class="btn" id="btnClear">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
        <div class="filters">
          <div class="chip on" data-filter="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="chip" data-filter="GBKK4">GBKK4</div>
          <div class="chip" data-filter="GBKK6">GBKK6</div>
          <div class="chip" data-filter="PIN">‡∏´‡∏°‡∏∏‡∏î</div>
        </div>
      </div>

      <div class="list" id="list"></div>

    </div>

    <!-- Map -->
    <div class="mapWrap">
      <div id="map"></div>
    </div>
  </div>

</div>

<!-- Sidebar -->
<div class="sbOverlay" id="sbOverlay"></div>
<aside class="sidebar" id="sidebar">
  <div class="sbTop">
    <div class="sbBrand">
      <b>PHANToM Tools</b>
      <span>CVS / Reports / Utilities</span>
    </div>
    <button class="sbClose" id="sbClose">‚úï</button>
  </div>

  <div class="sbBody">
    <div class="sbGroup">
      <h4>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h4>
      <a class="sbLink" href="Tools/Report.html" target="_self">
        <div>Report Script</div>
        <small>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤</small>
      </a>
      <a class="sbLink" href="Tools/Timestamp.html" target="_self">
        <div>Timestamp Tool</div>
        <small>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤</small>
      </a>
    </div>

    <div class="sbGroup">
      <h4>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
      <div style="font-size:12px;color:var(--muted);line-height:1.5">
        ‚Ä¢ ‡∏Å‡∏î‡∏ó‡∏µ‡πà ‚ÄúReport‚Äù ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏´‡∏°‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Popup<br>
        ‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å+‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏•‡∏ô‡πå‚Äù ‡πÉ‡∏ô Popup ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å History ‡∏•‡∏á LocalStorage ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Report.html
      </div>
    </div>
  </div>
</aside>

<!-- Report Popup -->
<div class="repOverlay" id="repOverlay">
  <div class="repBox">
    <div class="repHead">
      <div class="left">
        <b id="repTitle">Report</b>
        <span id="repSub">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</span>
      </div>
      <div class="right">
        <button class="hbtn" id="repReload">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
        <button class="hbtn" id="repClose">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
    <div class="repBody">
      <iframe class="repFrame" id="repFrame" title="Report Popup" src="about:blank"></iframe>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
========================= */
const CONFIG = {
  REPORT_PATH: 'Tools/Report.html',
  // localStorage keys ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Report.html (‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡∏•‡∏¥‡πâ‡∏á‡∏Å‡∏±‡∏ô‚Äù)
  REPORT_KEYS: {
    STORE_FORM: 'PT_REPORT_FORM_V1',
    STORE_HISTORY: 'PT_REPORT_HISTORY_V1'
  },
  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô history ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
  HISTORY_LIMIT: 80
};

/* =========================
   STATE
========================= */
let DATA = [];
let FILTER = 'ALL';
let MAP, MARKERS = [];
let USER_MARKER = null;

let REPORT_CTX = null;                // place ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏≠‡∏¢‡∏π‡πà
let REPORT_FRAME_READY = false;
let REPORT_PREFILL_TMR = null;
let REPORT_COPY_HOOKED = false;
let REPORT_EMBED_PATCHED = false;

/* =========================
   HELPERS
========================= */
const $ = (id)=>document.getElementById(id);

function showToast(msg){
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('on');
  clearTimeout(showToast._tmr);
  showToast._tmr = setTimeout(()=>t.classList.remove('on'), 1400);
}

function normText(s){
  return (s||'')
    .toString()
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase();
}

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, (c)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function safeJSONParse(s, fallback){
  try{ return JSON.parse(s); }catch(e){ return fallback; }
}

/* =========================
   SIDEBAR
========================= */
function openSidebar(){
  $('sbOverlay').classList.add('on');
  $('sidebar').classList.add('on');
}
function closeSidebar(){
  $('sbOverlay').classList.remove('on');
  $('sidebar').classList.remove('on');
}
$('btnBurger').addEventListener('click', openSidebar);
$('sbOverlay').addEventListener('click', closeSidebar);
$('sbClose').addEventListener('click', closeSidebar);

/* =========================
   REPORT POPUP
========================= */
function openReport(place){
  REPORT_CTX = place;

  $('repTitle').textContent = `Report ‚Ä¢ ${place?.zone || ''}`.trim();
  $('repSub').textContent = `${place?.account || ''} ‚Ä¢ ${place?.number || ''} ‚Ä¢ ${place?.account_name || ''}`.trim() || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶';

  $('repOverlay').classList.add('on');

  var frame = $('repFrame');

  // IMPORTANT: ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ frame.src ‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ browser ‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏°‡πâ src="" (‡∏ó‡∏≥‡πÉ‡∏´‡πâ popup ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡πà‡∏≤)
  var attrSrc = (frame.getAttribute('src') || '').trim();
  var isBlank = (!attrSrc) || (attrSrc === 'about:blank');

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ src ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô about:blank)
  if(!frame.dataset.loaded || isBlank){
    frame.dataset.loaded = '1';

    // ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô relative path ‡πÄ‡∏û‡∏∑‡πà‡∏≠ same-origin
    var baseUrl = new URL(CONFIG.REPORT_PATH, location.href).toString();

    frame.onload = function(){
      REPORT_FRAME_READY = true;

      // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ù‡∏±‡πà‡∏á iframe: ‡∏ï‡∏±‡∏î UI + patch storage + hook copy
      tryTrimReportUI();
      patchReportEmbedStorageOnce();
      attachCopyHistoryHookOnce();

      // Prefill ‡πÅ‡∏ö‡∏ö‡∏ß‡∏ô‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏à‡∏≠ field (‡∏Å‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πâ‡∏≤)
      startPrefillLoop();
    };
    frame.onerror = function(){
      showToast('Report ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ path: ' + CONFIG.REPORT_PATH + ')');
    };

    frame.src = baseUrl + (baseUrl.indexOf('?')>=0 ? '&' : '?') + 'embed=1';
  }else{
    // ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß -> ‡πÅ‡∏Ñ‡πà prefill ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° context
    startPrefillLoop();
  }
}

function closeReport(){
  $('repOverlay').classList.remove('on');
  REPORT_CTX = null;
}

$('repClose').addEventListener('click', closeReport);
$('repOverlay').addEventListener('click', (e)=>{
  if(e.target === $('repOverlay')) closeReport();
});
$('repReload').addEventListener('click', ()=>{
  const frame = $('repFrame');
  try{
    // reload iframe ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á cache
    const u = new URL(frame.src || new URL(CONFIG.REPORT_PATH, location.href).toString());
    u.searchParams.set('r', Date.now().toString());
    frame.src = u.toString();
    showToast('‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î Report ‡πÅ‡∏•‡πâ‡∏ß');
  }catch(e){
    frame.src = new URL(CONFIG.REPORT_PATH, location.href).toString();
  }
});

/* =========================
   IFRAME UTIL
========================= */
function getReportWin(){
  const frame = $('repFrame');
  return frame && frame.contentWindow ? frame.contentWindow : null;
}
function getReportDoc(){
  const win = getReportWin();
  try{ return win && win.document ? win.document : null; }catch(e){ return null; }
}

/* =========================
   REPORT: UI TRIM (‡∏ã‡πà‡∏≠‡∏ô Summary/History ‡πÉ‡∏ô embed)
========================= */
function tryTrimReportUI(){
  const doc = getReportDoc();
  if(!doc) return;

  // ‡∏ã‡πà‡∏≠‡∏ô Summary/History cards ‡πÅ‡∏ö‡∏ö ‚Äú‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á layout‚Äù ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å h3/h4/label ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ summary/history
  const candidates = Array.from(doc.querySelectorAll('section, .card, .panel, .box, div'));
  const badWords = ['history','‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥','summary','‡∏™‡∏£‡∏∏‡∏õ','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'];

  candidates.forEach(el=>{
    const t = normText(el.textContent);
    if(!t) return;
    // ‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏á‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡∏ä‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ history ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏û‡∏≠
    const hit = badWords.some(w => t.indexOf(w)!==-1);
    if(hit && (t.length < 2000)){
      // ‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô form ‡∏´‡∏•‡∏±‡∏Å: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ input ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
      const inputs = el.querySelectorAll('input, textarea, select').length;
      if(inputs >= 3) return;
      el.style.display = 'none';
    }
  });
}

/* =========================
   REPORT: PATCH STORAGE (‡πÑ‡∏°‡πà save account/‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô ‡πÉ‡∏ô embed)
========================= */
function patchReportEmbedStorageOnce(){
  if(REPORT_EMBED_PATCHED) return;
  const win = getReportWin();
  if(!win) return;

  try{
    const LS = win.localStorage;
    const origSet = LS.setItem.bind(LS);

    LS.setItem = function(k, v){
      try{
        if(k === CONFIG.REPORT_KEYS.STORE_FORM){
          const obj = safeJSONParse(v, null);
          if(obj && typeof obj === 'object'){
            // blank 3 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ save form ‡∏à‡∏≤‡∏Å embed
            obj.account = '';
            obj.branchCode = '';
            obj.branchName = '';
            return origSet(k, JSON.stringify(obj));
          }
        }
      }catch(e){}
      return origSet(k, v);
    };

    REPORT_EMBED_PATCHED = true;
  }catch(e){}
}

/* =========================
   REPORT: PREFILL (account/number/account_name -> account/branchCode/branchName)
========================= */
function startPrefillLoop(){
  clearInterval(REPORT_PREFILL_TMR);
  REPORT_PREFILL_TMR = setInterval(()=>{
    if(!REPORT_CTX) return;

    const doc = getReportDoc();
    if(!doc) return;

    // ‡∏´‡∏≤ field ‡πÅ‡∏ö‡∏ö ‚Äúsemantic‚Äù ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤ selector
    const accountField   = findFieldBySemantic(doc, ['account','‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå','‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ô‡∏ó‡πå']);
    const branchCodeField= findFieldBySemantic(doc, ['branchcode','‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤','‡∏™‡∏≤‡∏Ç‡∏≤','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤']);
    const branchNameField= findFieldBySemantic(doc, ['branchname','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô','‡∏ä‡∏∑‡πà‡∏≠']);

    const ok = !!(accountField || branchCodeField || branchNameField);

    if(ok){
      // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤ field ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á)
      if(accountField)    setFieldValue(accountField, REPORT_CTX.account || '');
      if(branchCodeField) setFieldValue(branchCodeField, REPORT_CTX.number || '');
      if(branchNameField) setFieldValue(branchNameField, REPORT_CTX.account_name || '');

      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï preview ‡πÇ‡∏î‡∏¢ trigger input event
      if(accountField)    fireInput(accountField);
      if(branchCodeField) fireInput(branchCodeField);
      if(branchNameField) fireInput(branchNameField);

      // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏´‡∏•‡∏±‡∏á prefill ‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ 3 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å save‚Äù (‡∏ù‡∏±‡πà‡∏á Report.html ‡∏≠‡∏≤‡∏à save ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
      // ‡πÄ‡∏£‡∏≤ patch setItem ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß -> ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

      clearInterval(REPORT_PREFILL_TMR);
      REPORT_PREFILL_TMR = null;
    }
  }, 160);
}

function findFieldBySemantic(doc, keywords){
  // 1) ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏á id / name
  for(const kw of keywords){
    const byId = doc.getElementById(kw);
    if(byId && (byId.tagName==='INPUT' || byId.tagName==='TEXTAREA' || byId.tagName==='SELECT')) return byId;

    const byName = doc.querySelector(`[name="${CSS.escape(kw)}"]`);
    if(byName) return byName;
  }

  // 2) ‡∏•‡∏≠‡∏á‡∏à‡∏≤‡∏Å label ‡∏ó‡∏µ‡πà‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á input
  const labels = Array.from(doc.querySelectorAll('label'));
  for(const lb of labels){
    const t = normText(lb.textContent);
    if(!t) continue;
    const hit = keywords.some(kw => t.indexOf(normText(kw))!==-1);
    if(!hit) continue;

    const forId = lb.getAttribute('for');
    if(forId){
      const el = doc.getElementById(forId);
      if(el) return el;
    }

    // ‡∏ñ‡πâ‡∏≤ label ‡∏Ñ‡∏£‡∏≠‡∏ö input ‡∏≠‡∏¢‡∏π‡πà
    const inside = lb.querySelector('input, textarea, select');
    if(inside) return inside;

    // ‡∏ñ‡πâ‡∏≤ label ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô input
    const next = lb.parentElement ? lb.parentElement.querySelector('input, textarea, select') : null;
    if(next) return next;
  }

  // 3) fallback: ‡∏Ñ‡πâ‡∏ô input ‡∏ó‡∏µ‡πà‡∏°‡∏µ placeholder/aria-label ‡∏ï‡∏£‡∏á keyword
  const fields = Array.from(doc.querySelectorAll('input, textarea, select'));
  for(const f of fields){
    const p = normText(f.getAttribute('placeholder')||'');
    const a = normText(f.getAttribute('aria-label')||'');
    const n = normText(f.getAttribute('name')||'');
    const i = normText(f.getAttribute('id')||'');

    const all = `${p} ${a} ${n} ${i}`;
    const hit = keywords.some(kw => all.indexOf(normText(kw))!==-1);
    if(hit) return f;
  }

  return null;
}

function setFieldValue(el, val){
  try{
    el.value = val;
  }catch(e){}
}
function fireInput(el){
  try{
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  }catch(e){}
}

/* =========================
   REPORT: COPY -> SAVE HISTORY (‡∏•‡∏¥‡πâ‡∏á‡∏Å‡∏±‡∏ö Report.html)
========================= */
function attachCopyHistoryHookOnce(){
  if(REPORT_COPY_HOOKED) return;
  var doc = getReportDoc();
  if(!doc || !doc.body) return;

  // ‡∏ü‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô Report.html ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å" / "copy"
  // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å+‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏•‡∏ô‡πå" ‡∏î‡πâ‡∏ß‡∏¢ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏≤ id ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏Ç‡∏±‡∏î logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Report.html
  doc.addEventListener('click', function(ev){
    var el = null;
    try{
      el = ev.target && ev.target.closest
        ? ev.target.closest('button, a, input[type="button"], input[type="submit"]')
        : null;
    }catch(e){ el = null; }
    if(!el) return;

    var t = normText(el.textContent || el.value || '');
    if(!(t.indexOf('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å') !== -1 || t.indexOf('copy') !== -1)) return;

    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ù‡∏±‡πà‡∏á Report.html ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ/‡πÄ‡∏ï‡∏¥‡∏° history
    setTimeout(function(){
      try{ ensureHistoryExistsFallback(); }catch(e){}
    }, 450);
  }, true);

  REPORT_COPY_HOOKED = true;
}

function ensureHistoryExistsFallback(){
  const win = getReportWin();
  const doc = getReportDoc();
  if(!win || !doc) return;

  // ‡∏≠‡πà‡∏≤‡∏ô preview text
  const preview = doc.getElementById('preview') || doc.querySelector('pre#preview') || doc.querySelector('pre');
  const txt = (preview && preview.textContent) ? preview.textContent.trim() : '';

  if(!txt) return;

  // ‡∏≠‡πà‡∏≤‡∏ô 3 ‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const accountEl = doc.getElementById('account') || findFieldBySemantic(doc, ['account','‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå','‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ô‡∏ó‡πå']);
  const codeEl    = doc.getElementById('branchCode') || findFieldBySemantic(doc, ['branchcode','‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤','‡∏™‡∏≤‡∏Ç‡∏≤','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤']);
  const nameEl    = doc.getElementById('branchName') || findFieldBySemantic(doc, ['branchname','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô','‡∏ä‡∏∑‡πà‡∏≠']);

  const account = accountEl ? (accountEl.value||'') : (REPORT_CTX?.account || '');
  const branchCode = codeEl ? (codeEl.value||'') : (REPORT_CTX?.number || '');
  const branchName = nameEl ? (nameEl.value||'') : (REPORT_CTX?.account_name || '');

  const now = Date.now();

  // ‡∏≠‡πà‡∏≤‡∏ô history ‡πÄ‡∏î‡∏¥‡∏°
  var arr = readHistoryArray(win);

  // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥: ‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î reportText ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô -> ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
  if(arr.length && (arr[arr.length-1].reportText || '').trim() === txt){
    return;
  }

  // ‡πÉ‡∏™‡πà entry ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Report.html
  arr.push({
    id: 'h_' + now,
    createdAt: now,
    reportDateISO: null,
    reportText: txt,
    account: account,
    branchCode: branchCode,
    branchName: branchName
  });

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
  if(arr.length > CONFIG.HISTORY_LIMIT){
    arr = arr.slice(arr.length - CONFIG.HISTORY_LIMIT);
  }

  writeHistoryArray(win, arr);
}

function readHistoryArray(win){
  try{
    const raw = win.localStorage.getItem(CONFIG.REPORT_KEYS.STORE_HISTORY);
    const arr = safeJSONParse(raw, []);
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function writeHistoryArray(win, arr){
  try{
    win.localStorage.setItem(CONFIG.REPORT_KEYS.STORE_HISTORY, JSON.stringify(arr));
  }catch(e){}
}

/* =========================
   MAP + LIST (‡πÄ‡∏î‡πÇ‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ)
========================= */
// NOTE: ‡∏™‡πà‡∏ß‡∏ô DATA ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô repo
// ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á logic ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£ fetch code.js ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏à‡∏∞‡∏ó‡∏±‡∏ö DATA ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°)

function initMap(){
  MAP = L.map('map', { zoomControl:true }).setView([13.7563, 100.5018], 11);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(MAP);
}

function render(){
  // Render list (placeholder)
  const el = $('list');
  el.innerHTML = '';
  const filtered = applyFilter(DATA);

  $('subTitle').textContent = `‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${filtered.length} ‡∏à‡∏∏‡∏î`;

  filtered.forEach((p)=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="cardHead">
        <div class="cMeta" style="min-width:0">
          <div class="cTitle">
            <span class="badge">${escapeHtml(p.zone||'-')}</span>
            <span style="font-weight:900">${escapeHtml(p.account_name||'-')}</span>
          </div>
          <div class="mini">${escapeHtml(p.account||'')} ‚Ä¢ ${escapeHtml(p.number||'')}</div>
        </div>
        <div class="actions">
          <button class="act secondary pin ${p._pinned?'on':''}" data-act="pin" title="‡∏´‡∏°‡∏∏‡∏î">
            ${p._pinned?'üìå':'üìç'}
          </button>
          <button class="act" data-act="report">Report</button>
          <button class="act secondary" data-act="nav">Maps</button>
        </div>
      </div>
    `;
    div.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      e.stopPropagation();

      const act = btn.getAttribute('data-act');
      if(act==='pin'){
        p._pinned = !p._pinned;
        savePins();
        render();
        return;
      }
      if(act==='report'){
        openReport(p);
        return;
      }
      if(act==='nav'){
        openGoogleMaps(p);
        return;
      }
    });

    el.appendChild(div);
  });

  // Map markers (placeholder)
  renderMarkers(filtered);
}

function renderMarkers(list){
  // clear
  MARKERS.forEach(m=>m.remove());
  MARKERS = [];

  list.forEach((p)=>{
    if(!(p.lat && p.lng)) return;
    const m = L.marker([p.lat, p.lng]).addTo(MAP);
    m.on('click', ()=>openReport(p));
    MARKERS.push(m);
  });
}

function openGoogleMaps(p){
  if(!(p.lat && p.lng)){
    showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î lat/lng');
    return;
  }
  const url = `https://www.google.com/maps?q=${encodeURIComponent(p.lat+','+p.lng)}`;
  window.open(url, '_blank');
}

function applyFilter(arr){
  let out = arr.slice();

  const q = normText($('q').value);
  if(q){
    out = out.filter(p=>{
      const s = normText(`${p.zone} ${p.account} ${p.number} ${p.account_name}`);
      return s.indexOf(q)!==-1;
    });
  }

  if(FILTER==='GBKK4' || FILTER==='GBKK6'){
    out = out.filter(p => (p.zone||'')===FILTER);
  }else if(FILTER==='PIN'){
    out = out.filter(p => !!p._pinned);
  }
  return out;
}

function loadPins(){
  try{
    const raw = localStorage.getItem('PT_CVS_PINS_V1');
    const ids = safeJSONParse(raw, []);
    if(!Array.isArray(ids)) return;
    const set = new Set(ids);
    DATA.forEach(p=>{ p._pinned = set.has(String(p.id)); });
  }catch(e){}
}
function savePins(){
  try{
    const ids = DATA.filter(p=>p._pinned).map(p=>String(p.id));
    localStorage.setItem('PT_CVS_PINS_V1', JSON.stringify(ids));
  }catch(e){}
}

/* =========================
   LOCATE
========================= */
$('btnLocate').addEventListener('click', ()=>{
  if(!navigator.geolocation){
    showToast('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
    return;
  }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const ll = [lat, lng];
    if(USER_MARKER) USER_MARKER.remove();
    USER_MARKER = L.circleMarker(ll, {
      radius:9,
      weight:2,
      fillOpacity:.25
    }).addTo(MAP);
    MAP.setView(ll, 15);
    showToast('‡∏û‡∏≤‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
  }, ()=>{
    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ');
  }, {enableHighAccuracy:true, timeout:8000});
});

/* =========================
   FILTER UI
========================= */
document.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    document.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));
    ch.classList.add('on');
    FILTER = ch.getAttribute('data-filter') || 'ALL';
    render();
  });
});

$('q').addEventListener('input', ()=>{
  render();
});
$('btnClear').addEventListener('click', ()=>{
  $('q').value = '';
  render();
});

/* =========================
   INIT
========================= */
function boot(){
  initMap();

  // TODO: ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏ß‡∏¢ DATA ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å repo (fetch sheet / code.js)
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á data (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡πÇ‡∏î‡∏¢‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  DATA = [
    {id:1, zone:'GBKK4', account:'CJ MORE', number:'0123', account_name:'CJ MORE ‡∏™‡∏≤‡∏Ç‡∏≤ A', lat:13.7563, lng:100.5018},
    {id:2, zone:'GBKK6', account:'LAWSON', number:'0456', account_name:'LAWSON ‡∏™‡∏≤‡∏Ç‡∏≤ B', lat:13.73, lng:100.55},
  ];

  loadPins();
  render();
}
boot();
</script>
</body>
</html>
