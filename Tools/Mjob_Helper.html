<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Selfie + Time Logger (Mint Light)</title>

  <!-- Noto Sans Thai (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6fffb;
      --card:#ffffff;
      --line:#d7efe7;
      --text:#0f2a2a;
      --muted:#5f7a7a;
      --muted2:#87a3a3;
      --accent:#20c997;
      --soft:#e8fff7;
      --warn:#ffb020;
      --danger:#ff4d4f;
      --shadow:0 10px 30px rgba(16,65,58,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Noto Sans Thai", Segoe UI, Roboto, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    a{color:inherit}
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 90px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 12px 0;
    }
    .label{font-weight:800; letter-spacing:.2px}
    .muted{color:var(--muted)}
    .mini{font-size:12px}
    .grid2{display:grid; gap:12px; grid-template-columns: 1fr}
    .grid3{display:grid; gap:10px; grid-template-columns: 1fr}
    @media(min-width: 760px){
      .grid2{grid-template-columns: 1fr 1fr}
      .grid3{grid-template-columns: 1fr 1fr 1fr}
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(16,65,58,.08);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      line-height:1;
    }
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; filter:saturate(.5)}
    .btn.primary{
      background: linear-gradient(180deg, #32e0b0, #17b98b);
      border-color: rgba(0,0,0,.04);
      color:#08312b;
    }
    .btn.soft{
      background: var(--soft);
      border-color: var(--line);
    }
    .btn.danger{
      background: #ffecee;
      border-color: #ffd0d4;
      color: #7a1112;
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: #fff;
      font-weight: 800;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid var(--line);
      background: #fff;
      white-space:nowrap;
    }
    .badge.ok{background: var(--soft); border-color: var(--line); color:#0c4b3d}
    .badge.wait{background:#fff6e6; border-color:#ffe2b1; color:#6a3b00}
    .badge.err{background:#ffecee; border-color:#ffd0d4; color:#7a1112}

    .field{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      width:100%;
      font-size: 14px;
      background:#fff;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row.nowrap{flex-wrap:nowrap}
    .spacer{flex:1}
    .hr{height:1px; background:var(--line); margin:10px 0}

    /* switch */
    .switch{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background:#fff;
    }
    .switch input{width:22px; height:22px}

    /* HEADER (fixed) */
    header.top{
      position: fixed;
      top:0;
      left:0;
      right:0;
      z-index: 20;
      background: rgba(246,255,251,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(215,239,231,.85);
    }
    .topInner{
      max-width: 980px;
      margin: 0 auto;
      padding: 10px 14px 12px;
    }
    .titleRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .title{
      font-weight: 900;
      font-size: 20px;
    }
    .headActions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .iconBtn{
      width:46px;
      height:46px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .iconBtn.primary{
      background: linear-gradient(180deg, #32e0b0, #17b98b);
      border-color: rgba(0,0,0,.04);
    }
    .iconBtn span{font-size:18px}
    .headerBlock{
      margin-top:10px;
      padding: 10px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
    }

    /* Header rows */
    .nextRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .nextPill{
      min-width: 140px;
      justify-content: space-between;
      flex: 0 0 auto;
    }
    .nextBtn{
      flex: 1 1 auto;
      height: 44px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 15px;
    }
    .timeRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .timeBox{
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: var(--soft);
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height: 66px;
      justify-content:center;
    }
    .timeBox .k{font-size: 12px; font-weight: 900; color: var(--muted)}
    .timeBox .v{
      font-size: 26px;
      font-weight: 900;
      letter-spacing:.3px;
      line-height: 1.05;
      color: #053a31;
    }
    .timeBox .sub{font-size: 12px; color: var(--muted)}
    .subline{
      margin-top:8px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* photo list */
    .photoList{display:grid; grid-template-columns: 1fr; gap:10px}
    @media(min-width: 760px){ .photoList{grid-template-columns: 1fr 1fr} }

    .photoCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background:#fff;
      padding:10px;
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:10px;
      align-items: start;
    }
    .thumb{
      width:92px; height:92px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: #f3fffa;
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .thumb img{width:100%; height:100%; object-fit: cover}
    .metaTop{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .metaLine{
      margin-top:6px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
    }
    .metaLine strong{color: var(--text)}
    .actions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .btn.small{
      padding:10px 12px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 13px;
    }
    .editMini{
      margin-left:auto;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight: 900;
      font-size: 12px;
      box-shadow:none;
      cursor:pointer;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .editMini:active{transform: translateY(1px)}

    /* Sticky Bar */
    .stickyBar{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 30;
      background: rgba(246,255,251,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(215,239,231,.85);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .stickyInner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items: stretch;
    }
    .btnBigStart{
      flex: 1 1 auto;
      height: 52px;
      border-radius: 18px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .squareBtn{
      width: 52px;
      height: 52px;
      border-radius: 18px;
      padding:0;
      font-size: 18px;
      font-weight: 900;
    }

    /* modal */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(5,30,26,.45);
      z-index: 60;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width: min(980px, 100%);
      max-height: min(86vh, 900px);
      overflow:auto;
      background: #fff;
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: 0 18px 50px rgba(0,0,0,.22);
      padding: 14px;
    }
    .modalHeader{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .modalTitle{font-weight: 900; font-size: 16px}
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 82px;
      z-index: 90;
      background: #0b3b33;
      color:#eafff7;
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      font-weight: 900;
      font-size: 13px;
      display:none;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{display:block}

    /* camera */
    .camWrap{
      border:1px solid var(--line);
      border-radius: 18px;
      background: #0a2f29;
      overflow:hidden;
      position: relative;
      box-shadow: var(--shadow);
    }
    video{
      width: 100%;
      height: auto;
      display:block;
      transform-origin:center;
      background:#05211d;
    }
    .camBar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      background: rgba(255,255,255,.08);
      color:#eafff7;
      position:absolute;
      left:0; right:0; bottom:0;
      backdrop-filter: blur(6px);
    }
    .camBar .mini{color:#d8fff3}
    .camBtn{
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.10);
      color:#eafff7;
      border-radius: 14px;
      height: 44px;
      padding: 0 12px;
      font-weight: 900;
      cursor:pointer;
    }
    .camBtn:active{transform: translateY(1px)}
    .camBtn.primary{
      background: linear-gradient(180deg, rgba(50,224,176,.96), rgba(23,185,139,.92));
      color:#05211d;
      border-color: rgba(0,0,0,.12);
    }

    /* collapsible */
    .collapseHead{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .chev{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      font-weight: 900;
    }
    .collapseBody{
      overflow:hidden;
      max-height: 0;
      transition: max-height .25s ease;
    }
    .collapseBody.open{
      max-height: 2000px;
    }
  </style>
</head>

<body>
<header class="top" id="topHeader">
  <div class="topInner">
    <div class="titleRow">
      <div class="title">Selfie + Time Logger</div>
      <span class="badge ok" id="readyBadge">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
      <span class="badge wait" id="dlBadge">DL: 0 / 40</span>
      <div class="spacer"></div>
      <div class="headActions">
        <button class="iconBtn primary" id="btnOpenCam" title="‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á"><span>üì∑</span></button>
        <button class="iconBtn" id="btnPickFile" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î"><span>üñºÔ∏è</span></button>
        <button class="iconBtn" id="btnSettings" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"><span>‚öôÔ∏è</span></button>
        <input id="fileInput" type="file" accept="image/*" hidden />
      </div>
    </div>

    <!-- HEADER BLOCK (new layout) -->
    <div class="headerBlock">
      <div class="nextRow">
        <span class="pill nextPill">
          <span class="muted mini">Next</span>
          <span id="nextSlotLabel">-</span>
        </span>

        <button class="btn primary nextBtn" id="btnDownloadNext" disabled>‚Üì ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>

      <!-- ‡πÄ‡∏ß‡∏•‡∏≤ + ‡∏≠‡∏µ‡∏Å ‡∏•‡∏á‡∏°‡∏≤ 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î -->
      <div class="timeRow">
        <div class="timeBox">
          <div class="k">‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div class="v" id="timeBoxNow">--:--</div>
          <div class="sub" id="timeBoxTarget">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: --:--</div>
        </div>
        <div class="timeBox">
          <div class="k">‡∏≠‡∏µ‡∏Å</div>
          <div class="v" id="timeBoxRemain">--:--:--</div>
          <div class="sub" id="timeBoxHint">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</div>
        </div>
      </div>

      <div class="subline" id="headerSubline">
        <span id="statusLine">‚Äî</span>
      </div>
    </div>
  </div>
</header>

<div class="wrap" id="mainWrap">
  <!-- Pending -->
  <div class="card">
    <div class="row">
      <div class="label">Pending (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î)</div>
      <div class="spacer"></div>
      <span class="badge wait" id="pendingCountBadge">0</span>
    </div>
    <div class="muted mini" id="pendingHelp">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div>
    <div class="hr"></div>
    <div class="photoList" id="pendingList">
      <div class="muted mini">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Pending</div>
    </div>
  </div>

  <!-- Downloaded (collapsible) -->
  <div class="card">
    <div class="collapseHead" id="dlCollapseHead">
      <div class="chev" id="dlChev">‚ñ∏</div>
      <div class="label">Downloaded (‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß)</div>
      <div class="spacer"></div>
      <span class="badge ok" id="downloadedCountBadge">0</span>
    </div>
    <div class="muted mini">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏ö‡∏™‡∏ô)</div>
    <div class="hr"></div>
    <div class="collapseBody" id="dlCollapseBody">
      <div class="photoList" id="downloadedList">
        <div class="muted mini">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Downloaded</div>
      </div>
    </div>
  </div>

  <!-- Progress (moved to bottom) -->
  <div class="card">
    <div class="row">
      <div class="label">Progress</div>
      <div class="spacer"></div>
      <span class="badge" id="goalBadge">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 40 ‡∏£‡∏π‡∏õ</span>
    </div>
    <div class="hr"></div>
    <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
      <span class="pill mini" id="progText">Total: 0 ‚Ä¢ Downloaded: 0 ‚Ä¢ Pending: 0</span>
      <span class="badge ok" id="goalOk" style="display:none">‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</span>
    </div>
    <div style="margin-top:10px; height:12px; border:1px solid var(--line); border-radius:999px; overflow:hidden; background:#fff">
      <div id="progBar" style="height:100%; width:0%; background: linear-gradient(90deg, #32e0b0, #17b98b)"></div>
    </div>
  </div>
</div>

<!-- Sticky Bar -->
<div class="stickyBar" id="stickyBar">
  <div class="stickyInner">
    <button class="btn primary btnBigStart" id="btnStartTimer">‚è±Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</button>
    <button class="btn soft squareBtn" id="btnUnlock" title="‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ">üîì</button>
    <button class="btn danger squareBtn" id="btnWipe" title="‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">üóëÔ∏è</button>
  </div>
  <div class="mini muted" style="max-width:980px;margin:6px auto 0; padding:0 4px">
    * ‡∏õ‡∏•‡∏∏‡∏Å‡∏ô‡∏≠‡∏Å Chrome ‡πÑ‡∏°‡πà‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ (‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î) ‚Äî ‡πÉ‡∏ä‡πâ LINE ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ó‡∏ô
  </div>
</div>

<!-- Settings Modal -->
<div class="modalBackdrop" id="settingsBackdrop">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">Settings</div>
      <div class="spacer"></div>
      <button class="btn small" id="btnCloseSettings">‡∏õ‡∏¥‡∏î</button>
    </div>

    <div class="hr"></div>

    <div class="grid2">
      <label class="switch">
        <input type="checkbox" id="swMirror" checked>
        <div>
          <div class="label">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏Å (Mirror)</div>
          <div class="muted mini">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß & ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô</div>
        </div>
      </label>

      <label class="switch">
        <input type="checkbox" id="swCatchup" checked>
        <div>
          <div class="label">Catch-up ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡∏¥‡∏î</div>
          <div class="muted mini">‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>
        </div>
      </label>
    </div>

    <div class="hr"></div>

    <!-- LINE Notify via Worker -->
    <div class="card" style="box-shadow:none; margin:0; border-radius:16px">
      <div class="row">
        <div class="label">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE (‡∏ú‡πà‡∏≤‡∏ô Cloudflare Worker)</div>
        <div class="spacer"></div>
        <span class="badge ok" id="lineStatusBadge">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î</span>
      </div>
      <div class="muted mini" style="margin-top:6px">
        ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏ô‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ Chrome ‡∏Å‡πá‡πÄ‡∏î‡πâ‡∏á) ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á
      </div>

      <div class="hr"></div>

      <label class="switch">
        <input type="checkbox" id="swLineEnable">
        <div>
          <div class="label">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
          <div class="muted mini">‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ó‡∏ô Notification ‡∏Ç‡∏≠‡∏á Chrome</div>
        </div>
      </label>

      <div style="height:10px"></div>

      <div class="grid2">
        <div>
          <div class="label mini">LINE Bridge URL (Worker)</div>
          <input class="field" id="lineWorkerUrl" placeholder="https://...workers.dev" />
          <div class="muted mini" style="margin-top:6px">
            ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Worker ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <b>phantom-selfie-line.surakiatforwork.workers.dev</b>
          </div>
        </div>
        <div>
          <div class="label mini">‡πÇ‡∏Ñ‡πâ‡∏î‡∏ú‡∏π‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô PHANTOM1)</div>
          <input class="field" id="lineCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô PHANTOM1" />
          <div class="muted mini" style="margin-top:6px">
            1) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô OA ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô LINE<br>
            2) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏≤ OA: <b>LINK &lt;‡πÇ‡∏Ñ‡πâ‡∏î&gt;</b><br>
            3) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡∏î ‚Äú‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚Äù
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn soft" id="btnSaveLine">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn" id="btnTestLine">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
        <button class="btn danger" id="btnClearLine">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
        <div class="spacer"></div>
        <span class="muted mini" id="lineSaveHint">‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (localStorage)</span>
      </div>
    </div>

    <div class="hr"></div>

    <label class="switch">
      <input type="checkbox" id="swLog">
      <div>
        <div class="label">‡πÄ‡∏õ‡∏¥‡∏î Log panel</div>
        <div class="muted mini">‡πÉ‡∏ä‡πâ debug ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</div>
      </div>
    </label>

    <div id="logPanel" class="card" style="display:none; box-shadow:none">
      <div class="label">Logs</div>
      <pre id="logBox" class="mini" style="white-space:pre-wrap; margin:10px 0 0; color:#0b3b33"></pre>
    </div>
  </div>
</div>

<!-- Camera Modal -->
<div class="modalBackdrop" id="camBackdrop">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">Camera</div>
      <div class="spacer"></div>
      <button class="btn small" id="btnCloseCam">‡∏õ‡∏¥‡∏î</button>
    </div>

    <div style="height:10px"></div>

    <div class="camWrap">
      <video id="video" autoplay playsinline></video>
      <div class="camBar">
        <div>
          <div class="label mini" id="camStatTop">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Ä¶</div>
          <div class="mini" id="camStatSub">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ: 0 ‚Ä¢ ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: -</div>
        </div>
        <div class="row" style="gap:8px; flex-wrap:nowrap">
          <button class="camBtn" id="btnFlip">‡∏™‡∏•‡∏±‡∏ö</button>
          <button class="camBtn primary" id="btnShot">‡∏ñ‡πà‡∏≤‡∏¢</button>
        </div>
      </div>
    </div>

    <div class="muted mini" style="margin-top:10px">
      * ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° üñºÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ó‡∏ô
    </div>
  </div>
</div>

<div class="toast" id="toast">toast</div>

<script>
/**
 * =========================
 * 0) Dexie loader + fallback
 * =========================
 * - ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î Dexie ‡∏ú‡πà‡∏≤‡∏ô CDN 2 ‡πÅ‡∏´‡πà‡∏á
 * - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ native IndexedDB wrapper ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤
 */
const CDN_DEXIE = [
  "https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js",
  "https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"
];

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src=src; s.async=true;
    s.onload=()=>resolve(true);
    s.onerror=()=>reject(new Error("load failed: "+src));
    document.head.appendChild(s);
  });
}

async function ensureDexie(){
  if (window.Dexie) return true;
  for (const url of CDN_DEXIE){
    try{ await loadScript(url); if(window.Dexie) return true; }catch(e){}
  }
  return false;
}

/**
 * =========================
 * 1) State + helpers
 * =========================
 */
const $ = (id)=>document.getElementById(id);
const state = {
  db: null,
  useDexie: false,
  photos: new Map(), // slot -> record
  orderedSlots: [], // sequence
  ui: {
    headerH: 0,
    downloadedOpen: false,
    unlockUntil: 0,
  },
  timer: {
    startAt: 0,
    targetAt: 0,
    locked: false,
  },
  line: {
    enabled: false,
    worker: "https://phantom-selfie-line.surakiatforwork.workers.dev",
    code: "",
  },
  prefs: {
    mirror: true,
    catchup: true,
    log: false,
  },
  stream: null,
  facing: "user", // user/environment
  sched: {
    dueSlot: null,
    dueAt: 0,
    timeoutId: null,
    lastNotifiedKey: "", // slot@dueAt
  }
};

function log(...args){
  if(!state.prefs.log) return;
  const s = args.map(a=> typeof a==="string"? a : JSON.stringify(a,null,2)).join(" ");
  $("logBox").textContent += s + "\n";
}
function toast(msg, ms=2200){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(t._to);
  t._to=setTimeout(()=>t.classList.remove("show"), ms);
}

function fmt2(n){ return String(n).padStart(2,"0"); }
function fmtTime(ts){
  if(!ts) return "--:--";
  const d=new Date(ts);
  return fmt2(d.getHours())+":"+fmt2(d.getMinutes());
}
function fmtDateTime(ts){
  if(!ts) return "-";
  const d=new Date(ts);
  return `${fmt2(d.getDate())}/${fmt2(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)} ${fmt2(d.getHours())}:${fmt2(d.getMinutes())}:${fmt2(d.getSeconds())}`;
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/**
 * =========================
 * 2) Schema IndexedDB
 * =========================
 * photos table:
 *   - slot (PK) ‡πÄ‡∏ä‡πà‡∏ô IN-1, OUT-1 ...
 *   - kind, idx
 *   - createdAt (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏°)
 *   - updatedAt (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ/replace)
 *   - downloadedAt (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
 *   - blob (JPEG)
 *   - width, height, mime
 * meta table: key -> value (json)
 */
const DB_NAME = "selfie_time_logger_mint";
const DB_VER = 1;

async function openDB(){
  const okDexie = await ensureDexie();
  state.useDexie = okDexie;

  if(okDexie){
    const db = new Dexie(DB_NAME);
    db.version(DB_VER).stores({
      photos: "slot, kind, idx, createdAt, downloadedAt",
      meta: "key"
    });
    state.db = db;
    await db.open();
    log("DB: Dexie OK");
    return;
  }

  // Native fallback (minimal)
  log("DB: Dexie failed, use native IndexedDB fallback");
  state.db = await nativeOpen(DB_NAME, DB_VER);
}

// -------- Native IndexedDB fallback (minimal) --------
function nativeOpen(name, ver){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(name, ver);
    req.onupgradeneeded = ()=>{
      const db=req.result;
      if(!db.objectStoreNames.contains("photos")){
        const s=db.createObjectStore("photos", { keyPath:"slot" });
        s.createIndex("downloadedAt","downloadedAt",{unique:false});
        s.createIndex("createdAt","createdAt",{unique:false});
      }
      if(!db.objectStoreNames.contains("meta")){
        db.createObjectStore("meta", { keyPath:"key" });
      }
    };
    req.onsuccess=()=>resolve(new NativeDB(req.result));
    req.onerror=()=>reject(req.error);
  });
}
class NativeDB{
  constructor(db){ this.db=db; }
  tx(store, mode="readonly"){ return this.db.transaction(store, mode).objectStore(store); }
  async get(store, key){
    return new Promise((resolve,reject)=>{
      const req=this.tx(store).get(key);
      req.onsuccess=()=>resolve(req.result||null);
      req.onerror=()=>reject(req.error);
    });
  }
  async put(store, val){
    return new Promise((resolve,reject)=>{
      const req=this.tx(store,"readwrite").put(val);
      req.onsuccess=()=>resolve(true);
      req.onerror=()=>reject(req.error);
    });
  }
  async del(store, key){
    return new Promise((resolve,reject)=>{
      const req=this.tx(store,"readwrite").delete(key);
      req.onsuccess=()=>resolve(true);
      req.onerror=()=>reject(req.error);
    });
  }
  async clear(store){
    return new Promise((resolve,reject)=>{
      const req=this.tx(store,"readwrite").clear();
      req.onsuccess=()=>resolve(true);
      req.onerror=()=>reject(req.error);
    });
  }
  async allPhotos(){
    return new Promise((resolve,reject)=>{
      const req=this.tx("photos").getAll();
      req.onsuccess=()=>resolve(req.result||[]);
      req.onerror=()=>reject(req.error);
    });
  }
}

// DB helpers (Dexie/native)
async function dbGetMeta(key, def=null){
  if(state.useDexie){
    const row = await state.db.meta.get(key);
    return row ? row.value : def;
  }else{
    const row = await state.db.get("meta", key);
    return row ? row.value : def;
  }
}
async function dbSetMeta(key, value){
  if(state.useDexie){
    await state.db.meta.put({key, value});
  }else{
    await state.db.put("meta", {key, value});
  }
}
async function dbPutPhoto(rec){
  if(state.useDexie) await state.db.photos.put(rec);
  else await state.db.put("photos", rec);
}
async function dbGetPhoto(slot){
  if(state.useDexie) return await state.db.photos.get(slot);
  return await state.db.get("photos", slot);
}
async function dbDelPhoto(slot){
  if(state.useDexie) await state.db.photos.delete(slot);
  else await state.db.del("photos", slot);
}
async function dbAllPhotos(){
  if(state.useDexie) return await state.db.photos.toArray();
  return await state.db.allPhotos();
}
async function dbClearAll(){
  if(state.useDexie){
    await state.db.photos.clear();
    await state.db.meta.clear();
  }else{
    await state.db.clear("photos");
    await state.db.clear("meta");
  }
}

/**
 * =========================
 * 3) Slot sequence + tagging logic
 * =========================
 * - ‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß: IN-1, OUT-1, IN-2, OUT-2, ...
 * - ‡πÄ‡∏ï‡∏¥‡∏° "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢" ‡∏Å‡πà‡∏≠‡∏ô (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ in1/in2 ‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö)
 */
function makeSequence(maxIdx){
  const out=[];
  for(let i=1;i<=maxIdx;i++){
    out.push({slot:`IN-${i}`, kind:"IN", idx:i});
    out.push({slot:`OUT-${i}`, kind:"OUT", idx:i});
  }
  return out;
}
function computeMaxIdx(){
  // dynamic: ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 20, ‡πÅ‡∏•‡∏∞‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
  let mx=20;
  for(const rec of state.photos.values()){
    mx = Math.max(mx, rec.idx||0);
  }
  return mx;
}
function rebuildSequence(){
  const mx = computeMaxIdx();
  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï: ‡πÄ‡∏û‡∏¥‡πà‡∏° buffer ‡∏≠‡∏µ‡∏Å 10 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
  state.orderedSlots = makeSequence(mx+10);
}
function findFirstMissingSlot(){
  rebuildSequence();
  for(const it of state.orderedSlots){
    if(!state.photos.has(it.slot)) return it;
  }
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ missing (‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏ñ‡∏∂‡∏á) ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°
  const mx = computeMaxIdx()+30;
  state.orderedSlots = makeSequence(mx);
  for(const it of state.orderedSlots){
    if(!state.photos.has(it.slot)) return it;
  }
  return null;
}
function nextAfter(slot){
  rebuildSequence();
  const i = state.orderedSlots.findIndex(x=>x.slot===slot);
  if(i<0) return state.orderedSlots[0]?.slot || null;
  return state.orderedSlots[i+1]?.slot || null;
}

/**
 * nextSlot logic:
 * - ‡∏´‡∏≤ "‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å" ‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç "‡∏°‡∏µ‡∏£‡∏π‡∏õ + downloaded ‡πÅ‡∏•‡πâ‡∏ß"
 *   => ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î‡∏£‡∏π‡∏õ: next = ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
 *   => ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î: next = ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô
 *   => ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: next = null
 */
function computeNextSlot(){
  rebuildSequence();
  for(const it of state.orderedSlots){
    const rec = state.photos.get(it.slot);
    if(!rec) return {slot: it.slot, reason:"missing"};
    if(!rec.downloadedAt) return {slot: it.slot, reason:"pending"};
  }
  return {slot:null, reason:"done"};
}

function countDownloaded(){
  let c=0;
  for(const rec of state.photos.values()){
    if(rec.downloadedAt) c++;
  }
  return c;
}

/**
 * =========================
 * 4) Timer 9:10 + unlock window
 * =========================
 */
const DURATION_MS = (9*60 + 10) * 60 * 1000;

async function loadTimerFromDB(){
  const t = await dbGetMeta("timer", {startAt:0,targetAt:0,locked:false});
  state.timer = {...state.timer, ...t};
  const ul = await dbGetMeta("unlockUntil", 0);
  state.ui.unlockUntil = ul || 0;
}

async function saveTimerToDB(){
  await dbSetMeta("timer", state.timer);
  await dbSetMeta("unlockUntil", state.ui.unlockUntil);
}

function isUnlockedWindow(){
  return Date.now() < (state.ui.unlockUntil || 0);
}

function canResetTimerByClick(){
  // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° start ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠ reset ‡πÑ‡∏î‡πâ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà unlocked window ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö >=40
  if(countDownloaded() >= 40) return true;
  return isUnlockedWindow();
}

async function autoUnlockIfGoalMet(){
  if(countDownloaded() >= 40){
    state.timer.locked = false;
    state.ui.unlockUntil = 0;
    await saveTimerToDB();
  }
}

/**
 * =========================
 * 5) Scheduling "Time use" (align last due = targetAt)
 * =========================
 * ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î:
 * - ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á" ‡∏à‡∏≤‡∏Å nextSlot ‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á slot ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
 * - ‡πÉ‡∏´‡πâ due ‡∏Ç‡∏≠‡∏á slot ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ = targetAt ‡∏û‡∏≠‡∏î‡∏µ (‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Å‡∏é min/max)
 * - ‡∏Å‡∏é‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:
 *    ‡∏´‡∏•‡∏±‡∏á IN: 3‚Äì25 ‡∏ô‡∏≤‡∏ó‡∏µ
 *    ‡∏´‡∏•‡∏±‡∏á OUT: 4‚Äì30 ‡∏ô‡∏≤‡∏ó‡∏µ
 *    IN gap < OUT gap ‡πÄ‡∏™‡∏°‡∏≠
 *
 * ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ -> ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏π‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠/‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ" ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô
 */
function buildContiguousPendingSlots(){
  const nxt = computeNextSlot();
  if(!nxt.slot) return {nxt, slots:[]};

  rebuildSequence();
  const startIdx = state.orderedSlots.findIndex(x=>x.slot===nxt.slot);
  if(startIdx<0) return {nxt, slots:[]};

  const out = [];
  for(let i=startIdx;i<state.orderedSlots.length;i++){
    const it = state.orderedSlots[i];
    const rec = state.photos.get(it.slot);
    if(!rec) break; // ‡∏Ç‡∏≤‡∏î‡∏£‡∏π‡∏õ -> ‡∏´‡∏¢‡∏∏‡∏î
    if(rec.downloadedAt) break; // ‡πÄ‡∏à‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£) ‡∏Å‡πá‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    out.push(it);
  }
  return {nxt, slots: out};
}

function solveGaps(Dmin, nIn, nOut){
  // ‡∏´‡∏≤ gapIn/gapOut ‡πÉ‡∏´‡πâ sum = Dmin ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á + gapIn < gapOut
  // ‡πÉ‡∏ä‡πâ search ‡πÅ‡∏ö‡∏ö‡∏´‡∏¢‡∏≤‡∏ö‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
  if(nIn===0 && nOut===0) return null;

  if(nOut===0){
    const g = Dmin / nIn;
    if(g>=3 && g<=25) return {gIn:g, gOut:null};
    return null;
  }
  if(nIn===0){
    const g = Dmin / nOut;
    if(g>=4 && g<=30) return {gIn:null, gOut:g};
    return null;
  }

  // search gapIn 3..25 step 0.1
  let best=null, bestScore=1e18;
  for(let gi=3; gi<=25.0001; gi+=0.1){
    const go = (Dmin - nIn*gi) / nOut;
    if(go < 4 || go > 30) continue;
    if(!(gi < go)) continue;
    // score: ‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏• (‡πÉ‡∏´‡πâ OUT ‡πÑ‡∏°‡πà‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô)
    const avg = Dmin / (nIn+nOut);
    const score = Math.abs(gi-avg) + Math.abs(go-avg)*0.8 + Math.abs((go-gi)-2)*0.05;
    if(score < bestScore){
      bestScore=score;
      best={gIn:gi, gOut:go};
    }
  }
  return best;
}

function computeSchedule(){
  // returns { ok, reason, plan: Map(slot -> dueAt), dueSlot, dueAt }
  const now = Date.now();
  const nxtPack = buildContiguousPendingSlots();
  const {nxt, slots} = nxtPack;

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏° timer -> ‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì time use
  if(!state.timer.targetAt){
    return { ok:false, reason:"no_target", nxt, plan:new Map(), dueSlot:null, dueAt:0 };
  }

  // baseTime = lastDownloadedAt ‡∏Ç‡∏≠‡∏á slot ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô now
  let baseTime = now;
  let lastDlAt = 0;
  for(const rec of state.photos.values()){
    if(rec.downloadedAt) lastDlAt = Math.max(lastDlAt, rec.downloadedAt);
  }
  if(lastDlAt) baseTime = lastDlAt;

  if(!nxt.slot){
    return { ok:true, reason:"done", nxt, plan:new Map(), dueSlot:null, dueAt:0 };
  }

  // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà next -> ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏î‡∏£‡∏π‡∏õ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
  if(nxt.reason==="missing"){
    return { ok:false, reason:"missing_next", nxt, plan:new Map(), dueSlot:null, dueAt:0 };
  }

  // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ slots ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ plan
  if(slots.length===0){
    // next ‡πÄ‡∏õ‡πá‡∏ô pending ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ contiguous? (‡πÅ‡∏õ‡∏•‡∏Å) treat as cannot
    return { ok:false, reason:"no_slots", nxt, plan:new Map(), dueSlot:null, dueAt:0 };
  }

  const Dmin = (state.timer.targetAt - baseTime) / 60000;
  if(Dmin <= 0.2){
    // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß/‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å -> dueAt = now
    const plan = new Map();
    plan.set(nxt.slot, now);
    return { ok:true, reason:"past", nxt, plan, dueSlot:nxt.slot, dueAt: now };
  }

  // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å next ‡πÑ‡∏õ‡∏à‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
  const N = slots.length;
  let nIn=0, nOut=0;
  for(const it of slots){
    if(it.kind==="IN") nIn++; else nOut++;
  }

  // special: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 1 ‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ dueAt = targetAt (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏£‡∏á targetAt)
  if(N===1){
    const gap = (state.timer.targetAt - baseTime)/60000;
    const isIN = slots[0].kind==="IN";
    const okRange = isIN ? (gap>=3 && gap<=25) : (gap>=4 && gap<=30);
    const plan = new Map();
    if(okRange){
      plan.set(slots[0].slot, state.timer.targetAt);
      return { ok:true, reason:"single", nxt, plan, dueSlot: slots[0].slot, dueAt: state.timer.targetAt };
    }else{
      // ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á -> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Å‡∏é
      return { ok:false, reason:"cannot_fit", nxt, plan:new Map(), dueSlot:null, dueAt:0 };
    }
  }

  // ‡∏´‡∏≤ gapIn/gapOut ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡∏•‡∏á targetAt ‡∏û‡∏≠‡∏î‡∏µ
  const gaps = solveGaps(Dmin, nIn, nOut);
  if(!gaps){
    return { ok:false, reason:"cannot_fit", nxt, plan:new Map(), dueSlot:null, dueAt:0 };
  }

  const plan = new Map();
  let t = baseTime;
  for(const it of slots){
    const g = it.kind==="IN" ? gaps.gIn : gaps.gOut;
    t += g * 60000;
    plan.set(it.slot, Math.round(t/1000)*1000);
  }

  // ensure last equals targetAt (within rounding error)
  const lastSlot = slots[slots.length-1].slot;
  const lastDue = plan.get(lastSlot);
  const diff = Math.abs(lastDue - state.timer.targetAt);
  if(diff > 1500){
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 1.5s ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ fail (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ rounding)
    return { ok:false, reason:"cannot_fit", nxt, plan:new Map(), dueSlot:null, dueAt:0 };
  }

  // dueSlot ‡∏Ñ‡∏∑‡∏≠ slot ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (nxt.slot) ‡∏ã‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô plan
  const dueAt = plan.get(nxt.slot) || 0;
  return { ok:true, reason:"ok", nxt, plan, dueSlot:nxt.slot, dueAt };
}

/**
 * =========================
 * 6) LINE notify via Worker (/notify)
 * =========================
 * - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ LINE Notify (‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
 * - ‡πÉ‡∏ä‡πâ Worker ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠ token
 * - ‡πÄ‡∏ß‡πá‡∏ö‡∏™‡πà‡∏á { code, message } ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Worker
 */
function loadLineSettings(){
  const raw = localStorage.getItem("stl_line") || "";
  if(raw){
    try{
      const j = JSON.parse(raw);
      state.line.enabled = !!j.enabled;
      state.line.worker = j.worker || state.line.worker;
      state.line.code = j.code || "";
    }catch(e){}
  }
}
function saveLineSettings(){
  localStorage.setItem("stl_line", JSON.stringify({
    enabled: state.line.enabled,
    worker: state.line.worker,
    code: state.line.code
  }));
}
async function lineSend(message){
  if(!state.line.enabled) return {ok:false, skipped:true};
  if(!state.line.worker || !state.line.code) return {ok:false, error:"missing worker/code"};
  const url = state.line.worker.replace(/\/+$/,'') + "/notify";
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ code: state.line.code, message })
  });
  const data = await res.json().catch(()=>({ok:res.ok, status:res.status}));
  return data;
}

/**
 * =========================
 * 7) Notification engine (best-effort)
 * =========================
 * - ‡πÉ‡∏ä‡πâ LINE ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
 * - ‡∏ñ‡πâ‡∏≤ LINE ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå -> toast + beep ‡πÄ‡∏ö‡∏≤ ‡πÜ
 * - catch-up: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡∏¥‡∏î ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
 */
function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = 880;
    g.gain.value = 0.06;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 180);
  }catch(e){}
}

async function notifyUser(msg){
  // LINE first
  if(state.line.enabled){
    try{
      const r = await lineSend(msg);
      log("LINE notify result", r);
      if(r && r.ok) return;
      // fallback
    }catch(e){
      log("LINE notify error", e?.message||String(e));
    }
  }
  toast(msg);
  beep();
}

function clearScheduleTimer(){
  if(state.sched.timeoutId){
    clearTimeout(state.sched.timeoutId);
    state.sched.timeoutId = null;
  }
}
async function scheduleNextReminder(){
  clearScheduleTimer();
  await autoUnlockIfGoalMet();

  const sch = computeSchedule();
  const {nxt, dueSlot, dueAt} = sch;

  // header status
  let status = "";
  if(!state.timer.targetAt){
    status = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";
  }else if(nxt.slot && nxt.reason==="missing"){
    status = `‡∏Ç‡∏≤‡∏î‡∏£‡∏π‡∏õ ${nxt.slot}`;
  }else if(!sch.ok && sch.reason==="cannot_fit"){
    status = `‡∏£‡∏π‡∏õ/‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢`;
  }else if(dueSlot && dueAt){
    status = `‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ${dueSlot} ‚Ä¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô ${fmtTime(dueAt)}`;
  }else if(sch.reason==="done"){
    status = "‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß";
  }else{
    status = "‚Äî";
  }
  $("statusLine").textContent = status;

  // save plan for UI
  state.sched.dueSlot = dueSlot;
  state.sched.dueAt = dueAt;

  // if we have dueAt, set timer
  if(dueSlot && dueAt){
    const key = `${dueSlot}@${dueAt}`;
    // catch-up: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏à‡πâ‡∏á
    const now = Date.now();
    if(now >= dueAt){
      if(state.prefs.catchup && state.sched.lastNotifiedKey !== key){
        state.sched.lastNotifiedKey = key;
        await dbSetMeta("lastNotifiedKey", key);
        await notifyUser(dueSlot.startsWith("IN") ? `‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ Check In ‡πÅ‡∏•‡πâ‡∏ß (${dueSlot})` : `‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ Check Out ‡πÅ‡∏•‡πâ‡∏ß (${dueSlot})`);
      }
    }else{
      // schedule future
      const ms = dueAt - now;
      state.sched.timeoutId = setTimeout(async ()=>{
        const key2 = `${dueSlot}@${dueAt}`;
        const lastKey = await dbGetMeta("lastNotifiedKey", "");
        if(lastKey !== key2){
          state.sched.lastNotifiedKey = key2;
          await dbSetMeta("lastNotifiedKey", key2);
          await notifyUser(dueSlot.startsWith("IN") ? `‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ Check In ‡πÅ‡∏•‡πâ‡∏ß (${dueSlot})` : `‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ Check Out ‡πÅ‡∏•‡πâ‡∏ß (${dueSlot})`);
        }
        // reschedule (in case user still hasn't downloaded)
        scheduleNextReminder();
      }, clamp(ms, 500, 2**31-1));
    }
  }
}

/**
 * =========================
 * 8) Image processing (strip metadata by re-encode via canvas)
 * =========================
 */
async function fileToJpegBlob(file){
  // Use createImageBitmap with orientation fix if available
  let bmp;
  try{
    bmp = await createImageBitmap(file, { imageOrientation: "from-image" });
  }catch(e){
    bmp = await createImageBitmap(file);
  }
  const w=bmp.width, h=bmp.height;
  const canvas=document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(bmp,0,0);
  const blob = await new Promise(res=>canvas.toBlob(res,"image/jpeg",0.92));
  return {blob, width:w, height:h, mime:"image/jpeg"};
}

async function captureFromVideo(video, mirror){
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  const canvas = document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext("2d");
  if(mirror){
    ctx.translate(w,0);
    ctx.scale(-1,1);
  }
  ctx.drawImage(video,0,0,w,h);
  const blob = await new Promise(res=>canvas.toBlob(res,"image/jpeg",0.92));
  return {blob, width:w, height:h, mime:"image/jpeg"};
}

/**
 * =========================
 * 9) CRUD: add / replace / delete / download
 * =========================
 */
async function refreshFromDB(){
  const arr = await dbAllPhotos();
  state.photos = new Map(arr.map(x=>[x.slot,x]));
  rebuildSequence();

  // load meta + prefs
  await loadTimerFromDB();
  const lastKey = await dbGetMeta("lastNotifiedKey", "");
  state.sched.lastNotifiedKey = lastKey || "";

  renderAll();
  scheduleNextReminder();
}

async function addNewPhotoFromBlob(img){
  // choose slot = first missing (fills gaps)
  const next = findFirstMissingSlot();
  if(!next){ toast("‡πÑ‡∏°‡πà‡∏û‡∏ö slot ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"); return; }

  const now = Date.now();
  const rec = {
    slot: next.slot,
    kind: next.kind,
    idx: next.idx,
    createdAt: now,
    updatedAt: now,
    downloadedAt: 0,
    blob: img.blob,
    mime: img.mime || "image/jpeg",
    width: img.width||0,
    height: img.height||0
  };
  await dbPutPhoto(rec);
  state.photos.set(rec.slot, rec);
  toast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${rec.slot}`);
  renderAll();
  scheduleNextReminder();
}

async function replacePendingPhoto(slot, img){
  const rec = state.photos.get(slot);
  if(!rec) return;
  if(rec.downloadedAt){
    toast("‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
    return;
  }
  rec.blob = img.blob;
  rec.mime = img.mime || "image/jpeg";
  rec.width = img.width||0;
  rec.height = img.height||0;
  rec.updatedAt = Date.now();
  await dbPutPhoto(rec);
  state.photos.set(slot, rec);
  toast(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß: ${slot}`);
  renderAll();
  scheduleNextReminder();
}

async function deletePhoto(slot){
  await dbDelPhoto(slot);
  state.photos.delete(slot);
  toast(`‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${slot}`);
  renderAll();
  scheduleNextReminder();
}

async function downloadPhoto(slot){
  const rec = state.photos.get(slot);
  if(!rec) return;

  // download
  const blob = rec.blob;
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${slot}.jpg`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1200);

  // mark downloaded (first time only)
  if(!rec.downloadedAt){
    rec.downloadedAt = Date.now();
    await dbPutPhoto(rec);
    state.photos.set(slot, rec);
    toast(`‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${slot}`);
    log("Marked downloaded (first time):", slot);

    // unlock auto if reach >=40
    await autoUnlockIfGoalMet();
  }else{
    toast(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥: ${slot}`);
  }

  renderAll();
  scheduleNextReminder();
}

async function downloadNext(){
  const nxt = computeNextSlot();
  if(!nxt.slot){
    toast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏ñ‡∏±‡∏î‡πÑ‡∏õ");
    return;
  }
  if(nxt.reason==="missing"){
    toast(`‡∏Ç‡∏≤‡∏î‡∏£‡∏π‡∏õ ${nxt.slot}`);
    return;
  }
  await downloadPhoto(nxt.slot);
}

/**
 * =========================
 * 10) UI rendering
 * =========================
 */
function applyHeaderPadding(){
  const h = $("topHeader").getBoundingClientRect().height;
  state.ui.headerH = h;
  $("mainWrap").style.paddingTop = (h + 6) + "px";
}

function renderHeader(){
  const nxt = computeNextSlot();
  $("nextSlotLabel").textContent = nxt.slot || "-";
  // button download next
  $("btnDownloadNext").disabled = !(nxt.slot && nxt.reason==="pending");

  // time boxes
  const now = Date.now();
  $("timeBoxNow").textContent = fmtTime(now);
  $("timeBoxTarget").textContent = "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: " + (state.timer.targetAt ? fmtTime(state.timer.targetAt) : "--:--");
  if(state.timer.targetAt){
    const remain = Math.max(0, state.timer.targetAt - now);
    const hh = Math.floor(remain/3600000);
    const mm = Math.floor((remain%3600000)/60000);
    const ss = Math.floor((remain%60000)/1000);
    $("timeBoxRemain").textContent = `${fmt2(hh)}:${fmt2(mm)}:${fmt2(ss)}`;
    $("timeBoxHint").textContent = state.timer.locked ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°)" : "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï";
  }else{
    $("timeBoxRemain").textContent = "--:--:--";
    $("timeBoxHint").textContent = "‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";
  }

  // DL badge
  const dl = countDownloaded();
  $("dlBadge").textContent = `DL: ${dl} / 40`;
  $("goalOk").style.display = (dl>=40) ? "inline-flex" : "none";

  // start button label
  const btn = $("btnStartTimer");
  if(!state.timer.targetAt){
    btn.textContent = "‚è±Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";
  }else{
    btn.textContent = `‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ${fmtTime(state.timer.targetAt)}`;
  }

  // lock handling: ‡∏õ‡∏∏‡πà‡∏° start ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å (DL>=40 ‡∏´‡∏£‡∏∑‡∏≠ unlock window)
  const locked = state.timer.targetAt && state.timer.locked;
  if(locked){
    btn.disabled = !canResetTimerByClick();
  }else{
    btn.disabled = false;
  }

  // unlock button label as countdown
  const ubtn = $("btnUnlock");
  const left = (state.ui.unlockUntil || 0) - Date.now();
  if(left > 0 && countDownloaded() < 40){
    ubtn.textContent = `üîì${Math.ceil(left/1000)}`;
  }else{
    ubtn.textContent = "üîì";
  }
}

function renderProgress(){
  const total = state.photos.size;
  const dl = countDownloaded();
  const pending = total - dl;
  $("progText").textContent = `Total: ${total} ‚Ä¢ Downloaded: ${dl} ‚Ä¢ Pending: ${pending}`;
  const pct = Math.min(100, (dl/40)*100);
  $("progBar").style.width = pct.toFixed(1) + "%";
  $("pendingCountBadge").textContent = String(pending);
  $("downloadedCountBadge").textContent = String(dl);
}

function renderLists(){
  const dlArr = [];
  const pendArr = [];

  // render in slot order (fixed)
  rebuildSequence();
  const order = state.orderedSlots.map(x=>x.slot);
  for(const slot of order){
    const rec = state.photos.get(slot);
    if(!rec) continue;
    if(rec.downloadedAt) dlArr.push(rec);
    else pendArr.push(rec);
  }
  // include any extra slots that exceed our current sequence (rare)
  for(const rec of state.photos.values()){
    if(!order.includes(rec.slot)){
      (rec.downloadedAt?dlArr:pendArr).push(rec);
    }
  }

  // schedule plan for time use display
  const sch = computeSchedule();
  const plan = sch.plan || new Map();

  // Pending list
  const pEl = $("pendingList");
  pEl.innerHTML = "";
  if(pendArr.length===0){
    pEl.innerHTML = `<div class="muted mini">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Pending</div>`;
  }else{
    for(const rec of pendArr){
      const dueAt = plan.get(rec.slot) || 0;
      pEl.appendChild(renderPhotoCard(rec, false, dueAt));
    }
  }

  // Downloaded list
  const dEl = $("downloadedList");
  dEl.innerHTML = "";
  if(dlArr.length===0){
    dEl.innerHTML = `<div class="muted mini">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Downloaded</div>`;
  }else{
    for(const rec of dlArr){
      dEl.appendChild(renderPhotoCard(rec, true, 0));
    }
  }
}

function renderPhotoCard(rec, downloaded, dueAt){
  const wrap = document.createElement("div");
  wrap.className = "photoCard";

  // thumb
  const th = document.createElement("div");
  th.className = "thumb";
  const img = document.createElement("img");
  img.alt = rec.slot;
  img.src = URL.createObjectURL(rec.blob);
  img.onload = ()=> setTimeout(()=>URL.revokeObjectURL(img.src), 5000);
  th.appendChild(img);

  const right = document.createElement("div");

  const top = document.createElement("div");
  top.className = "metaTop";

  const tag = document.createElement("span");
  tag.className = "badge " + (downloaded ? "ok" : "wait");
  tag.textContent = rec.slot;
  top.appendChild(tag);

  if(downloaded){
    const b = document.createElement("span");
    b.className = "badge ok";
    b.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ";
    top.appendChild(b);
  }

  // time use line + edit (pending only)
  const line = document.createElement("div");
  line.className = "metaLine";
  const created = document.createElement("span");
  created.innerHTML = `<strong>‡πÄ‡∏û‡∏¥‡πà‡∏°:</strong> ${fmtDateTime(rec.createdAt)}`;
  line.appendChild(created);

  const tuse = document.createElement("span");
  if(dueAt){
    tuse.innerHTML = `<strong>Time use:</strong> ${fmtTime(dueAt)}`;
  }else{
    tuse.innerHTML = `<strong>Time use:</strong> -`;
  }
  line.appendChild(tuse);

  if(!downloaded){
    const edit = document.createElement("button");
    edit.className = "editMini";
    edit.innerHTML = `‚úèÔ∏è <span class="mini">Edit</span>`;
    edit.onclick = ()=>{
      // replace flow: ask camera or file
      openReplaceMenu(rec.slot);
    };
    line.appendChild(edit);
  }

  // actions
  const act = document.createElement("div");
  act.className = "actions";
  const b1 = document.createElement("button");
  b1.className = "btn small" + (downloaded ? "" : " primary");
  b1.textContent = "‚¨áÔ∏è Download";
  b1.onclick = ()=> downloadPhoto(rec.slot);

  const b2 = document.createElement("button");
  b2.className = "btn small danger";
  b2.textContent = "üóëÔ∏è Delete";
  b2.onclick = async ()=>{
    if(!confirm(`‡∏•‡∏ö‡∏£‡∏π‡∏õ ${rec.slot} ?`)) return;
    await deletePhoto(rec.slot);
  };

  act.appendChild(b1);
  act.appendChild(b2);

  right.appendChild(top);
  right.appendChild(line);
  right.appendChild(act);

  wrap.appendChild(th);
  wrap.appendChild(right);
  return wrap;
}

function renderAll(){
  applyHeaderPadding();
  renderHeader();
  renderProgress();
  renderLists();
}

/**
 * =========================
 * 11) Replace pending photo (Edit button)
 * =========================
 * - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Pending ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Downloaded ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ)
 * - ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ñ‡πà‡∏≤‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î" ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö slot ‡πÄ‡∏î‡∏¥‡∏°
 */
let replaceSlot = null;

function openReplaceMenu(slot){
  replaceSlot = slot;
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡πà‡∏≤‡∏¢: ‡πÉ‡∏ä‡πâ confirm ‡πÅ‡∏¢‡∏Å (mobile-friendly)
  const okCam = confirm(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ ${slot}\n‡∏Å‡∏î OK = ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô\n‡∏Å‡∏î Cancel = ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà`);
  if(okCam){
    openCamera(true); // replace mode
  }else{
    // open file picker replace
    $("fileInput").click();
    $("fileInput").dataset.replace = slot;
  }
}

/**
 * =========================
 * 12) Camera (mirror + switch)
 * =========================
 */
async function stopStream(){
  if(state.stream){
    try{ state.stream.getTracks().forEach(t=>t.stop()); }catch(e){}
  }
  state.stream = null;
  $("video").srcObject = null;
}

async function openCamera(replaceMode=false){
  replaceSlot = replaceMode ? replaceSlot : null;

  $("camBackdrop").classList.add("show");
  $("camStatTop").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Ä¶";
  $("camStatSub").textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ: ${state.photos.size} ‚Ä¢ ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${computeNextSlot().slot || "-"}`;

  // try open camera
  try{
    await stopStream();
    const constraints = {
      video: { facingMode: state.facing }
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    state.stream = stream;
    $("video").srcObject = stream;

    // mirror preview if user cam + mirror enabled
    updateVideoMirror();

    $("camStatTop").textContent = replaceSlot ? `‡πÇ‡∏´‡∏°‡∏î Replace: ${replaceSlot}` : "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢";
  }catch(e){
    $("camStatTop").textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
    toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ó‡∏ô");
    log("camera error", e?.message||String(e));
  }
}

function updateVideoMirror(){
  const v = $("video");
  const shouldMirror = (state.facing==="user" && state.prefs.mirror);
  v.style.transform = shouldMirror ? "scaleX(-1)" : "none";
}

async function takeShot(){
  const v = $("video");
  if(!state.stream || !v.videoWidth){
    toast("‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°");
    return;
  }
  const shouldMirrorSaved = (state.facing==="user" && state.prefs.mirror);

  const img = await captureFromVideo(v, shouldMirrorSaved);

  if(replaceSlot){
    await replacePendingPhoto(replaceSlot, img);
    replaceSlot = null;
    // stay open or close? ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
    closeCamera();
    return;
  }else{
    await addNewPhotoFromBlob(img);
    // update stat
    $("camStatSub").textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ: ${state.photos.size} ‚Ä¢ ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${computeNextSlot().slot || "-"}`;
  }
}

function closeCamera(){
  $("camBackdrop").classList.remove("show");
  replaceSlot = null;
  stopStream();
}

/**
 * =========================
 * 13) Start timer button behavior (2-step)
 * =========================
 * - ‡∏Å‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ + ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î HH:MM"
 * - ‡∏Å‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) -> ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ ‡∏´‡∏£‡∏∑‡∏≠ DL>=40
 */
async function onStartTimer(){
  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° -> ‡πÄ‡∏£‡∏¥‡πà‡∏°
  if(!state.timer.targetAt){
    const now = Date.now();
    state.timer.startAt = now;
    state.timer.targetAt = now + DURATION_MS;
    state.timer.locked = true; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πá‡∏≠‡∏Å (‡∏õ‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ DL>=40 ‡∏´‡∏£‡∏∑‡∏≠ unlock window)
    await saveTimerToDB();
    toast("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
    await notifyUser(`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${fmtTime(state.timer.targetAt)}`);
    renderAll();
    scheduleNextReminder();
    return;
  }

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß -> ‡∏Å‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á = ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ)
  if(state.timer.locked && !canResetTimerByClick()){
    toast("‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô (üîì) ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö 40");
    return;
  }

  // reset
  state.timer.startAt = 0;
  state.timer.targetAt = 0;
  state.timer.locked = false;
  state.ui.unlockUntil = 0;
  await saveTimerToDB();
  toast("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
  scheduleNextReminder();
}

async function onUnlock(){
  // ‡∏ñ‡πâ‡∏≤ DL>=40 -> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ñ‡∏≤‡∏ß‡∏£
  if(countDownloaded() >= 40){
    state.timer.locked = false;
    state.ui.unlockUntil = 0;
    await saveTimerToDB();
    toast("‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏£‡∏ö 40)");
    renderAll();
    return;
  }

  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏î‡πâ
  state.ui.unlockUntil = Date.now() + 3000;
  await saveTimerToDB();
  toast("‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ");
  renderAll();

  // refresh countdown UI
  const tick = ()=>{
    renderHeader();
    if(Date.now() < state.ui.unlockUntil) requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
}

async function onWipe(){
  if(!confirm("‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1)")) return;
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á ‡πÜ? (‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2)")) return;
  await dbClearAll();
  state.photos.clear();
  state.timer = {startAt:0,targetAt:0,locked:false};
  state.ui.unlockUntil = 0;
  state.sched.lastNotifiedKey = "";
  localStorage.removeItem("stl_line"); // optional
  toast("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
  await refreshFromDB();
}

/**
 * =========================
 * 14) UI events
 * =========================
 */
function wireUI(){
  // header actions
  $("btnOpenCam").onclick = ()=> openCamera(false);
  $("btnPickFile").onclick = ()=> $("fileInput").click();
  $("btnSettings").onclick = ()=> openSettings();
  $("btnDownloadNext").onclick = ()=> downloadNext();

  // file input (add or replace)
  $("fileInput").addEventListener("change", async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      const img = await fileToJpegBlob(f);
      const rs = $("fileInput").dataset.replace || "";
      if(rs){
        $("fileInput").dataset.replace = "";
        await replacePendingPhoto(rs, img);
      }else{
        await addNewPhotoFromBlob(img);
      }
    }catch(err){
      toast("‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      log("file error", err?.message||String(err));
    }finally{
      e.target.value="";
    }
  });

  // camera modal
  $("btnCloseCam").onclick = closeCamera;
  $("btnShot").onclick = takeShot;
  $("btnFlip").onclick = async ()=>{
    state.facing = (state.facing==="user") ? "environment" : "user";
    await openCamera(!!replaceSlot);
  };

  // sticky
  $("btnStartTimer").onclick = onStartTimer;
  $("btnUnlock").onclick = onUnlock;
  $("btnWipe").onclick = onWipe;

  // downloaded collapse
  $("dlCollapseHead").onclick = ()=>{
    state.ui.downloadedOpen = !state.ui.downloadedOpen;
    $("dlCollapseBody").classList.toggle("open", state.ui.downloadedOpen);
    $("dlChev").textContent = state.ui.downloadedOpen ? "‚ñæ" : "‚ñ∏";
  };

  // settings
  $("btnCloseSettings").onclick = closeSettings;

  $("swMirror").onchange = ()=>{
    state.prefs.mirror = $("swMirror").checked;
    localStorage.setItem("stl_prefs", JSON.stringify(state.prefs));
    updateVideoMirror();
  };
  $("swCatchup").onchange = ()=>{
    state.prefs.catchup = $("swCatchup").checked;
    localStorage.setItem("stl_prefs", JSON.stringify(state.prefs));
  };
  $("swLog").onchange = ()=>{
    state.prefs.log = $("swLog").checked;
    localStorage.setItem("stl_prefs", JSON.stringify(state.prefs));
    $("logPanel").style.display = state.prefs.log ? "block" : "none";
  };

  // LINE settings
  $("swLineEnable").onchange = ()=>{
    state.line.enabled = $("swLineEnable").checked;
    saveLineSettings();
    updateLineUI();
  };
  $("btnSaveLine").onclick = ()=>{
    state.line.worker = $("lineWorkerUrl").value.trim() || state.line.worker;
    state.line.code = $("lineCode").value.trim();
    saveLineSettings();
    updateLineUI();
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ LINE ‡πÅ‡∏•‡πâ‡∏ß");
  };
  $("btnClearLine").onclick = ()=>{
    if(!confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ LINE ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á?")) return;
    state.line.enabled = false;
    state.line.code = "";
    // worker keep default
    saveLineSettings();
    updateLineUI();
    toast("‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
  };
  $("btnTestLine").onclick = async ()=>{
    state.line.worker = $("lineWorkerUrl").value.trim() || state.line.worker;
    state.line.code = $("lineCode").value.trim();
    saveLineSettings();
    updateLineUI();

    if(!state.line.code){
      toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ú‡∏π‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
      return;
    }
    try{
      const r = await lineSend("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å Selfie Logger ‚úÖ");
      if(r && r.ok){
        toast("‡∏™‡πà‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      }else{
        toast("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ LINK ‡πÇ‡∏Ñ‡πâ‡∏î/‡πÄ‡∏ô‡πá‡∏ï)");
        log("test line result", r);
      }
    }catch(e){
      toast("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï)");
      log("test line error", e?.message||String(e));
    }
  };

  // window resize for header padding
  window.addEventListener("resize", ()=>applyHeaderPadding());

  // tick clock
  setInterval(()=>renderHeader(), 1000);
}

function loadPrefs(){
  const raw = localStorage.getItem("stl_prefs") || "";
  if(raw){
    try{ Object.assign(state.prefs, JSON.parse(raw)); }catch(e){}
  }
  $("swMirror").checked = !!state.prefs.mirror;
  $("swCatchup").checked = !!state.prefs.catchup;
  $("swLog").checked = !!state.prefs.log;
  $("logPanel").style.display = state.prefs.log ? "block" : "none";
}

function openSettings(){
  $("settingsBackdrop").classList.add("show");
  // fill values
  $("lineWorkerUrl").value = state.line.worker || "";
  $("lineCode").value = state.line.code || "";
  $("swLineEnable").checked = !!state.line.enabled;
  updateLineUI();
}
function closeSettings(){
  $("settingsBackdrop").classList.remove("show");
}
function updateLineUI(){
  $("lineStatusBadge").textContent = state.line.enabled ? "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î";
  $("lineStatusBadge").className = "badge " + (state.line.enabled ? "ok" : "wait");
}

/**
 * =========================
 * 15) Boot
 * =========================
 */
(async function boot(){
  loadPrefs();
  loadLineSettings();

  await openDB();
  await refreshFromDB();

  wireUI();
  applyHeaderPadding();

  // set initial line UI values
  updateLineUI();

  // auto unlock if goal met
  await autoUnlockIfGoalMet();
  renderAll();

  log("BOOT OK");
})();
</script>

<!--
=====================================
‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ (‡∏™‡∏±‡πâ‡∏ô ‡πÜ)
=====================================
1) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ:
   - ‡∏Å‡∏î üì∑ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ üñºÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
   - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÅ‡∏ó‡πá‡∏Å‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞ ‚Äú‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‚Äù ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö)

2) ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î:
   - ‡∏Å‡∏î ‚Äú‚Üì ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Download ‡∏£‡∏≤‡∏¢‡∏£‡∏π‡∏õ
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Download ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡∏à‡∏∞ mark ‡∏ß‡πà‡∏≤ ‚Äú‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ Downloaded
   - ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)

3) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤:
   - ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á ‚Äú‚è±Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‚Äù -> ‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°
   - ‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Downloaded >= 40
   - ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î üîì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏î‡πâ)

4) ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE:
   - ‡πÄ‡∏õ‡∏¥‡∏î Settings (‚öôÔ∏è) -> ‡πÄ‡∏õ‡∏¥‡∏î ‚ÄúLINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚Äù
   - ‡πÉ‡∏™‡πà Worker URL (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß) + ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î ‡πÄ‡∏ä‡πà‡∏ô PHANTOM1
   - ‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤ OA: LINK PHANTOM1
   - ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡∏î ‚Äú‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚Äù

‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î:
- ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏∏‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô‡∏õ‡∏¥‡∏î Chrome/‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö (‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)
- LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á (‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏à‡∏∞ fallback ‡πÄ‡∏õ‡πá‡∏ô toast/beep ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ)
-->
</body>
</html>
