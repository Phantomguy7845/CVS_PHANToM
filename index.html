<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>GBKK4 Tracker</title>

  <!-- Leaflet + OSM (‡∏ü‡∏£‡∏µ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ API key) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      /* Mint Light (‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡∏î) */
      --bg:#f4fbf9;
      --card:#ffffff;
      --text:#071915;
      --muted:#3b6760;
      --line:rgba(7,25,21,.12);
      --mint:#14b8a6;
      --mint2:#0ea293;
      --shadow:0 10px 26px rgba(0,0,0,.08);
      --r:18px;
      --tap:44px;
      --danger:#e23a3a;

      /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÅ‡∏ñ‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏•‡πà‡∏≤‡∏á */
      --bottomTabsH:76px;

      /* Sidebar */
      --sbW: 290px;
      --sbZ: 100001;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#e9fbf7,var(--bg));
      color:var(--text);
    }

    /* header */
    header{
      position:sticky; top:0; z-index:99997;
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      color:#fff;
      padding:12px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.14);
    }
    .hdr{
      display:flex; gap:10px; align-items:center;
    }

    /* ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π Sidebar */
    .menu-btn{
      min-height:40px;
      min-width:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      font-weight:1000;
      font-size:18px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .menu-btn:active{ transform:scale(.99); }

    .title{
      font-weight:1000;
      font-size:18px;
      display:flex; gap:8px; align-items:center;
      flex-wrap:wrap;
      line-height:1.15;
    }
    /* ‚úÖ ‡∏™‡πÄ‡∏ï‡∏ï‡∏±‡∏™‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ */
    .tstats{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }

    .badge{
      margin-left:auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.16);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }

    /* controls mobile-first */
    .controls{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .search{
      flex:1 1 240px;
      min-height:var(--tap);
      display:flex; align-items:center; gap:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      padding:10px 12px;
    }
    .search input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:#fff;
      font-size:16px;
    }
    .search input::placeholder{color:rgba(255,255,255,.78)}
    select, button{
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:10px 12px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform:scale(.99)}
    .btn-solid{
      background:rgba(255,255,255,.92);
      color:#0b2f2a;
      border-color:rgba(255,255,255,.92);
    }
    .btn-danger{
      background:rgba(226,58,58,.18);
      color:#fff;
      border-color:rgba(255,255,255,.25);
    }

    main{
      max-width:920px;
      margin:0 auto;
      padding:14px;
      padding-bottom: calc(14px + var(--bottomTabsH) + env(safe-area-inset-bottom));
    }

    /* pages */
    .page{ display:none; }
    .page.active{ display:block; }

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:12px 14px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#fbfffe);
    }
    .panel-h strong{font-size:14px}
    .meta{
      margin-left:auto;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }

    /* list items */
    .list{display:flex; flex-direction:column}
    .item{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .item:last-child{border-bottom:none}
    .name{
      font-weight:1000;
      font-size:15px;
      line-height:1.25;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }
    .warn{color:#b05a00}
    .actions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .a-btn{
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(20,184,166,.28);
      background:rgba(20,184,166,.12);
      color:#064e46;
      padding:10px 12px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
    }
    .a-btn[disabled]{opacity:.6; cursor:not-allowed}
    .a-nav{background:rgba(20,184,166,.14)}
    .a-done{background:rgba(20,184,166,.18)}

    /* loading */
    .center{
      padding:22px 14px;
      text-align:center;
      color:var(--muted);
      font-weight:1000;
    }
    .spinner{
      width:46px; height:46px;
      border-radius:999px;
      border:5px solid rgba(20,184,166,.18);
      border-top-color:var(--mint);
      margin:0 auto 12px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* map page */
    .map-wrap{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .map-h{
      padding:12px 14px;
      display:flex; gap:10px; align-items:center;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#fbfffe);
    }
    .map-h strong{font-size:14px}
    .pill{
      margin-left:auto;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(20,184,166,.30);
      background:rgba(20,184,166,.12);
      color:#064e46;
      font-size:12px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    #map{height:72vh; min-height:360px; width:100%}

    /* modal */
    .backdrop{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.45);
      z-index:99999;
    }
    .modal{
      width:min(560px,100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 20px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal h3{
      margin:0;
      padding:14px 14px 8px;
      font-size:16px;
      font-weight:1000;
    }
    .modal .body{
      padding:0 14px 14px;
      color:#23443f;
      font-weight:900;
      white-space:pre-line;
      font-size:14px;
    }
    .m-actions{
      padding:12px 14px;
      border-top:1px solid rgba(0,0,0,.10);
      display:flex; justify-content:flex-end; gap:10px;
    }
    .m-btn{
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background:#f0f5f4;
      color:#071915;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    .m-ok{
      background:rgba(20,184,166,.16);
      border-color:rgba(20,184,166,.35);
      color:#064e46;
    }
    .m-danger{
      background:rgba(226,58,58,.12);
      border-color:rgba(226,58,58,.28);
      color:#7b1111;
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + var(--bottomTabsH) + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      display:none;
      max-width:min(560px,calc(100% - 24px));
      text-align:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(6,27,22,.88);
      color:#fff;
      font-weight:900;
      font-size:13px;
      z-index:100000;
    }

    /* Leaflet popup buttons */
    .map-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(20,184,166,.35);
      background:rgba(20,184,166,.14);
      color:#064e46;
      font-weight:1000;
      text-decoration:none;
      min-height:40px;
      line-height:1;
      width:100%;
    }
    .map-actions{
      display:flex;
      gap:10px;
      margin-top:8px;
    }
    .map-actions .map-link:active{ transform:scale(.99); }

    .map-done{
      border-color:rgba(226,58,58,.28);
      background:rgba(226,58,58,.10);
      color:#7b1111;
      cursor:pointer;
    }
    .map-link[disabled],
    .map-link.disabled{
      opacity:.6;
      cursor:not-allowed;
      pointer-events:none;
    }

    /* Current location marker */
    .me-icon{ background: transparent !important; border: none !important; }
    .me-dot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ffffff;
      border: 5px solid var(--mint);
      box-shadow: 0 0 0 6px rgba(20, 184, 166, .18);
      position: relative;
    }
    .me-dot::after{
      content:'';
      position:absolute;
      inset:-10px;
      border-radius:999px;
      border: 2px solid rgba(20, 184, 166, .35);
      animation: mePulse 1.6s ease-out infinite;
    }
    @keyframes mePulse{
      0%   { transform: scale(.65); opacity: .9; }
      100% { transform: scale(1.25); opacity: 0; }
    }

    /* Bottom Tabs */
    .bottom-tabs{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:99998;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.92);
      border-top:1px solid rgba(7,25,21,.10);
      box-shadow:0 -10px 24px rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .bottom-tabs .row{
      max-width:920px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .tabbtn{
      flex:1;
      min-height:var(--tap);
      border-radius:16px;
      border:1px solid rgba(20,184,166,.28);
      background:rgba(20,184,166,.10);
      color:#064e46;
      padding:10px 12px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .tabbtn.active{
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      border-color:rgba(15,143,131,.25);
      color:#fff;
    }
    .tabbtn:active{ transform:scale(.99); }

    /* =========================
       ‚úÖ SIDEBAR (‡πÉ‡∏´‡∏°‡πà)
       ========================= */
    .sb-overlay{
      position:fixed;
      inset:0;
      z-index:var(--sbZ);
      background:rgba(0,0,0,.38);
      display:none;
      touch-action: manipulation;
    }
    .sb-overlay.show{ display:block; }

    .sidebar{
      position:absolute;
      left:0; top:0; bottom:0;
      width:min(var(--sbW), calc(100% - 64px));
      background:linear-gradient(180deg,#ffffff,#f6fffd);
      border-right:1px solid rgba(7,25,21,.10);
      box-shadow: 18px 0 40px rgba(0,0,0,.18);
      transform:translateX(-104%);
      transition:transform .22s ease;
      padding:12px;
      padding-top: calc(12px + env(safe-area-inset-top));
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .sb-overlay.show .sidebar{ transform:translateX(0); }

    .sb-head{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 6px 12px;
      border-bottom:1px solid rgba(7,25,21,.10);
      margin-bottom:12px;
    }
    .sb-title{
      font-weight:1000;
      color:#071915;
      font-size:16px;
    }
    .sb-close{
      margin-left:auto;
      min-height:40px;
      border-radius:14px;
      border:1px solid rgba(20,184,166,.25);
      background:rgba(20,184,166,.10);
      color:#064e46;
      padding:8px 12px;
      font-weight:1000;
      cursor:pointer;
    }

    .sb-section{
      margin-top:12px;
      font-weight:1000;
      font-size:12px;
      color:#3b6760;
      letter-spacing:.2px;
      text-transform:uppercase;
      padding:0 6px;
    }

    .sb-link{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      margin-top:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(20,184,166,.22);
      background:rgba(20,184,166,.10);
      color:#064e46;
      font-weight:1000;
      text-decoration:none;
      cursor:pointer;
    }
    .sb-link:active{ transform:scale(.99); }
    .sb-ico{
      width:34px; height:34px;
      border-radius:12px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(20,184,166,.22);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .sb-text{
      display:flex;
      flex-direction:column;
      line-height:1.15;
    }
    .sb-text small{
      font-weight:900;
      color:rgba(6,78,70,.75);
      margin-top:4px;
      font-size:12px;
    }
  </style>
</head>

<body>

<!-- ‚úÖ Sidebar Overlay -->
<div id="sbOverlay" class="sb-overlay" aria-hidden="true">
  <aside class="sidebar" role="navigation" aria-label="Tools Sidebar">
    <div class="sb-head">
      <div class="sb-title">üß∞ Tools</div>
      <button id="sbClose" class="sb-close" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>

    <div class="sb-section">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>

    <!-- ‚úÖ Tool #1: Report Script -->
    <a class="sb-link" href="https://phantomguy7845.github.io/CVS_PHANToM/Tools/Report.html">
      <div class="sb-ico">üßæ</div>
      <div class="sb-text">
        Report Script
        <small>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Report.html</small>
      </div>
    </a>

    <!-- (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ ‡πÇ‡∏î‡∏¢‡∏Å‡πá‡∏≠‡∏õ‡∏õ‡∏µ‡πâ a.sb-link ‡πÄ‡∏û‡∏¥‡πà‡∏°) -->
  </aside>
</div>

<header>
  <div class="hdr">
    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Sidebar -->
    <button id="btnMenu" class="menu-btn" type="button" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">‚ò∞</button>

    <div class="title">
      üìç GBKK4 Tracker
      <span id="titleStats" class="tstats">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Äî | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî</span>
    </div>
    <div id="badge" class="badge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
  </div>

  <div id="controls" class="controls">
    <div class="search">
      üîé
      <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‚Ä¶" autocomplete="off">
    </div>

    <select id="sortMode" aria-label="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö">
      <option value="default">‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</option>
      <option value="nearest">‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô</option>
    </select>

    <button id="btnRefresh" class="btn-solid" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    <button id="btnResetAll" class="btn-danger" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>
</header>

<main>
  <section id="pageList" class="page active">
    <section class="panel">
      <div class="panel-h">
        <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏õ</strong>
        <div id="meta" class="meta">‚Äî</div>
      </div>

      <div id="list" class="list">
        <div class="center">
          <div class="spinner"></div>
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶
        </div>
      </div>
    </section>
  </section>

  <section id="pageMap" class="page">
    <section class="map-wrap">
      <div class="map-h">
        <strong>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</strong>
        <div id="gpsPill" class="pill">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ GPS</div>
      </div>
      <div id="map"></div>
    </section>
  </section>
</main>

<nav class="bottom-tabs" role="tablist" aria-label="‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤">
  <div class="row">
    <button id="tabList" class="tabbtn active" type="button">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button id="tabMap" class="tabbtn" type="button">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
  </div>
</nav>

<div id="backdrop" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="mTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
    <div id="mBody" class="body">‚Äî</div>
    <div class="m-actions">
      <button id="mCancel" class="m-btn" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="mOk" class="m-btn m-ok" type="button">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">‚Äî</div>

<script>
  /** =========================
   *  CONFIG (‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ)
   *  ========================= */
  const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbxT9l21k-IusbjU6T8of0PwHwCVeqrseDSaM1lPWz9B0qwhF6SgmdtZw7oDSvU2HykAwg/exec'
  };

  function $(id){ return document.getElementById(id); }

  function escapeHtml(s){
    s = (s === null || s === undefined) ? '' : String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  function showToast(msg){
    var t = $('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(function(){ t.style.display='none'; }, 2200);
  }

  function openModal(opts){
    opts = opts || {};
    $('mTitle').textContent = opts.title || '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
    $('mBody').textContent  = opts.body  || '‚Äî';
    $('mOk').textContent    = opts.okText || '‡∏ï‡∏Å‡∏•‡∏á';
    $('mCancel').textContent= opts.cancelText || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';

    $('mOk').className = 'm-btn ' + (opts.danger ? 'm-danger' : 'm-ok');

    $('backdrop').style.display = 'flex';
    $('backdrop').setAttribute('aria-hidden','false');

    return new Promise(function(resolve){
      function cleanup(){
        $('backdrop').style.display='none';
        $('backdrop').setAttribute('aria-hidden','true');
        $('mOk').onclick = null;
        $('mCancel').onclick = null;
      }
      $('mOk').onclick = function(){ cleanup(); resolve(true); };
      $('mCancel').onclick = function(){ cleanup(); resolve(false); };
    });
  }

  /** =========================
   *  ‚úÖ SIDEBAR LOGIC (‡πÉ‡∏´‡∏°‡πà)
   *  ========================= */
  function openSidebar(){
    var o = $('sbOverlay');
    o.classList.add('show');
    o.setAttribute('aria-hidden','false');
  }
  function closeSidebar(){
    var o = $('sbOverlay');
    o.classList.remove('show');
    o.setAttribute('aria-hidden','true');
  }
  function sidebarIsOpen(){
    return $('sbOverlay').classList.contains('show');
  }

  $('btnMenu').addEventListener('click', function(e){
    e.stopPropagation();
    openSidebar();
  });
  $('sbClose').addEventListener('click', function(e){
    e.stopPropagation();
    closeSidebar();
  });

  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (overlay) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
  $('sbOverlay').addEventListener('click', function(ev){
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏ï‡∏±‡∏ß sidebar ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î
    if(ev.target && ev.target.id === 'sbOverlay'){
      closeSidebar();
    }
  });

  // ‡∏Å‡∏î ESC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ö‡∏ô PC)
  window.addEventListener('keydown', function(e){
    if(e.key === 'Escape' && sidebarIsOpen()){
      closeSidebar();
    }
  });

  /** =========================
   *  ‚úÖ FULLSCREEN (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
   *  =========================
   *  ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏ï‡πâ‡∏≠‡∏á "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏∞/‡∏Ñ‡∏•‡∏¥‡∏Å" ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ fullscreen ‡πÑ‡∏î‡πâ
   *  ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞:
   *   1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ fullscreen ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
   *   2) ‡∏ñ‡πâ‡∏≤‡πÇ‡∏î‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡∏à‡∏∞‡∏£‡∏≠‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤ fullscreen ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
   */
  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
  }

  function requestFullscreen(){
    var el = document.documentElement;

    var fn = el.requestFullscreen
      || el.webkitRequestFullscreen
      || el.msRequestFullscreen;

    if(!fn) return Promise.reject(new Error('Fullscreen API not supported'));
    try{
      var r = fn.call(el);
      if(r && typeof r.then === 'function') return r;
      return Promise.resolve(true);
    }catch(e){
      return Promise.reject(e);
    }
  }

  function attachFullscreenOnFirstGesture(){
    if(attachFullscreenOnFirstGesture._done) return;
    attachFullscreenOnFirstGesture._done = true;

    function handler(){
      if(isFullscreen()) return;
      requestFullscreen().catch(function(){});
    }

    document.addEventListener('click', handler, { once:false, passive:true });
    document.addEventListener('touchend', handler, { once:false, passive:true });
    document.addEventListener('keydown', handler, { once:false });
  }

  function tryFullscreenOnOpen(){
    if(isFullscreen()) return;

    requestFullscreen().catch(function(){
      showToast('‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠');
      attachFullscreenOnFirstGesture();
    });
  }

  document.addEventListener('visibilitychange', function(){
    if(!document.hidden){
      setTimeout(function(){
        tryFullscreenOnOpen();
      }, 200);
    }
  });

  /** =========================
   *  JSONP Helper
   *  ========================= */
  function jsonp(url, timeoutMs){
    timeoutMs = timeoutMs || 15000;

    return new Promise(function(resolve, reject){
      var cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1e9);
      var timedOut = false;

      var timer = setTimeout(function(){
        timedOut = true;
        cleanup();
        reject(new Error('JSONP timeout'));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cbName]; }catch(e){ window[cbName] = undefined; }
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cbName] = function(data){
        if(timedOut) return;
        cleanup();
        resolve(data);
      };

      var sep = url.indexOf('?') >= 0 ? '&' : '?';
      var script = document.createElement('script');
      script.src = url + sep + 'callback=' + encodeURIComponent(cbName);
      script.onerror = function(){
        if(timedOut) return;
        cleanup();
        reject(new Error('JSONP load error'));
      };
      document.head.appendChild(script);
    });
  }

  function apiUrl(action, params){
    if(!CONFIG.API_URL || CONFIG.API_URL === 'PASTE_YOUR_APPS_SCRIPT_EXEC_URL_HERE'){
      return '';
    }
    var base = CONFIG.API_URL;
    var qs = 'action=' + encodeURIComponent(action);
    params = params || {};
    Object.keys(params).forEach(function(k){
      qs += '&' + encodeURIComponent(k) + '=' + encodeURIComponent(String(params[k]));
    });
    return base + (base.indexOf('?') >= 0 ? '&' : '?') + qs;
  }

  async function apiGetPlaces(){
    var url = apiUrl('getPlaces');
    if(!url) return { ok:false, message:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CONFIG.API_URL' };
    return await jsonp(url);
  }

  async function apiMarkVisited(id){
    var url = apiUrl('markVisited', { id:id });
    if(!url) return { ok:false, message:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CONFIG.API_URL' };
    return await jsonp(url);
  }

  async function apiResetVisitedAll(){
    var url = apiUrl('resetVisitedAll');
    if(!url) return { ok:false, message:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CONFIG.API_URL' };
    return await jsonp(url);
  }

  // ===== Data =====
  var META = { total:0, visited:0, remaining:0 };
  var PLACES = [];

  function renderTopStats(){
    $('titleStats').textContent =
      '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + META.total + ' | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + META.remaining + ' | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ' + META.visited;

    $('badge').textContent = (META.total ? ('‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + META.remaining + '/' + META.total) : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶');
  }

  // ===== Map =====
  var map = null;
  var layer = null;
  var currentMarker = null;
  var currentLatLng = null;
  var meIcon = null;

  function initMap(){
    if(map) return;
    try{
      map = L.map('map', { zoomControl:true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      layer = L.layerGroup().addTo(map);
      map.setView([13.95, 100.40], 11);

      meIcon = L.divIcon({
        className: 'me-icon',
        html: '<div class="me-dot"></div>',
        iconSize: [26, 26],
        iconAnchor: [13, 13]
      });

      if(currentLatLng){
        setCurrentLocation(currentLatLng.lat, currentLatLng.lng);
      }
    }catch(e){
      console.error(e);
      showToast('‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  function setCurrentLocation(lat, lng){
    currentLatLng = { lat:lat, lng:lng };
    if(!map) return;
    if(currentMarker) currentMarker.remove();

    currentMarker = L.marker([lat,lng], {
      icon: meIcon,
      zIndexOffset: 10000
    }).addTo(map).bindPopup('üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
  }

  function haversineKm(a, b){
    var R = 6371;
    function toRad(x){ return x*Math.PI/180; }
    var dLat = toRad(b.lat - a.lat);
    var dLng = toRad(b.lng - a.lng);
    var la1 = toRad(a.lat), la2 = toRad(b.lat);
    var s = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)*Math.sin(dLng/2);
    return 2*R*Math.asin(Math.sqrt(s));
  }

  function getOpenLink(place){
    var mapsUrl = (place && place.mapsUrl) ? String(place.mapsUrl).trim() : '';
    if(mapsUrl) return mapsUrl;

    if(place && place.lat !== null && place.lat !== undefined && place.lng !== null && place.lng !== undefined){
      var dest = place.lat + ',' + place.lng;
      return 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(dest) + '&travelmode=driving&dir_action=navigate';
    }
    return '';
  }

  function openMaps(place){
    var url = getOpenLink(place);
    if(!url){ showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏≥‡∏ó‡∏≤‡∏á'); return; }
    window.open(url, '_blank');
  }

  function filteredPlaces(){
    var q = $('q').value.trim().toLowerCase();
    var arr = PLACES.slice();

    if(q){
      arr = arr.filter(function(p){
        var id = (p && p.id) ? String(p.id) : '';
        var name = (p && p.name) ? String(p.name).toLowerCase() : '';
        return (id.indexOf(q) !== -1) || (name.indexOf(q) !== -1);
      });
    }

    var mode = $('sortMode').value;
    if(mode === 'nearest' && currentLatLng){
      arr = arr.map(function(p){
        var d = Number.POSITIVE_INFINITY;
        if(p && p.lat !== null && p.lat !== undefined && p.lng !== null && p.lng !== undefined){
          d = haversineKm(currentLatLng, {lat:p.lat, lng:p.lng});
        }
        p._d = d;
        return p;
      }).sort(function(a,b){ return (a._d || 0) - (b._d || 0); });
    }

    return arr;
  }

  function renderHeader(){
    renderTopStats();
    $('meta').textContent = '‡∏£‡∏ß‡∏°: ' + META.total + ' | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ' + META.visited;
  }

  function showLoading(){
    $('list').innerHTML =
      '<div class="center">' +
        '<div class="spinner"></div>' +
        '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶' +
      '</div>';
    $('badge').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶';
    $('titleStats').textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Äî | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî';
  }

  function renderList(){
    renderHeader();

    if(META.total > 0 && META.remaining === 0){
      $('list').innerHTML =
        '<div class="center">' +
          '<div style="font-size:18px;font-weight:1000;color:#064e46">‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß üéâ</div>' +
          '<div style="margin-top:6px;font-weight:900">visited ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà</div>' +
          '<div style="margin-top:12px">' +
            '<button id="btnResetInside" class="btn-solid" style="min-height:44px;border-radius:14px;padding:10px 14px;" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏•‡πâ‡∏≤‡∏á visited)</button>' +
          '</div>' +
        '</div>';
      $('btnResetInside').onclick = onResetAll;
      return;
    }

    var items = filteredPlaces();
    if(items.length === 0){
      $('list').innerHTML =
        '<div class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏•‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)</div>';
      return;
    }

    var html = '';
    for(var i=0;i<items.length;i++){
      var p = items[i];
      var hasLL = (p.lat !== null && p.lat !== undefined && p.lng !== null && p.lng !== undefined);
      var locText = hasLL ? (Number(p.lat).toFixed(6) + ', ' + Number(p.lng).toFixed(6)) : '<span class="warn">‚ö† ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>';

      html +=
        '<div class="item" data-id="' + escapeHtml(p.id) + '">' +
          '<div class="name">[' + escapeHtml(p.id) + '] ' + escapeHtml(p.name) + '</div>' +
          '<div class="sub">' + locText + '</div>' +
          '<div class="actions">' +
            '<button class="a-btn a-nav" data-act="nav" type="button">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>' +
            '<button class="a-btn a-done" data-act="done" type="button"><b>‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</b></button>' +
          '</div>' +
        '</div>';
    }
    $('list').innerHTML = html;

    var nodes = $('list').querySelectorAll('.item');
    nodes.forEach(function(el){
      var id = el.getAttribute('data-id');
      var place = PLACES.find(function(x){ return String(x.id) === String(id); });

      el.querySelector('[data-act="nav"]').onclick = function(){
        openMaps(place);
      };

      el.querySelector('[data-act="done"]').onclick = async function(){
        var ok = await openModal({
          title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
          body:'[' + place.id + '] ' + place.name + '\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏ô‡∏à‡∏≥‡∏Ñ‡πà‡∏≤ visited ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
          okText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
          cancelText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          danger:false
        });
        if(!ok) return;

        var btn = el.querySelector('[data-act="done"]');
        btn.disabled = true;
        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶';

        try{
          var res = await apiMarkVisited(place.id);
          if(!res || !res.ok){
            btn.disabled = false;
            btn.innerHTML = '<b>‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</b>';
            showToast(res && res.message ? res.message : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            return;
          }
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
          await loadPlaces();
        }catch(err){
          console.error(err);
          btn.disabled = false;
          btn.innerHTML = '<b>‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</b>';
          showToast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        }
      };
    });
  }

  function renderMap(){
    if(!map || !layer) return;
    layer.clearLayers();

    var items = filteredPlaces().filter(function(p){
      return (p.lat !== null && p.lat !== undefined && p.lng !== null && p.lng !== undefined);
    });

    items.forEach(function(p){
      var link = getOpenLink(p);

      var navHtml = link
        ? ('<a class="map-link" href="' + escapeHtml(link) + '" target="_blank" rel="noopener">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>')
        : ('<button class="map-link disabled" type="button" disabled>‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>');

      var doneHtml =
        '<button class="map-link map-done" type="button" data-id="' + escapeHtml(p.id) + '">‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</button>';

      var popup =
        '<div style="font-weight:1000;color:#071915">[' + escapeHtml(p.id) + '] ' + escapeHtml(p.name) + '</div>' +
        '<div class="map-actions">' + navHtml + doneHtml + '</div>';

      L.marker([p.lat, p.lng]).addTo(layer).bindPopup(popup);
    });

    var pts = [];
    if(currentLatLng) pts.push([currentLatLng.lat, currentLatLng.lng]);
    items.forEach(function(p){ pts.push([p.lat, p.lng]); });
    if(pts.length){
      try{ map.fitBounds(L.latLngBounds(pts).pad(0.15)); }catch(e){}
    }
  }

  document.addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('.map-done') : null;
    if(!btn) return;

    ev.preventDefault();
    ev.stopPropagation();

    var id = btn.getAttribute('data-id');
    var place = PLACES.find(function(x){ return String(x.id) === String(id); });
    if(!place){
      showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ');
      return;
    }

    try{ if(map) map.closePopup(); }catch(e){}

    openModal({
      title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
      body:'[' + place.id + '] ' + place.name + '\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ visited = 1 ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
      okText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)',
      cancelText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      danger:false
    }).then(async function(ok){
      if(!ok) return;

      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶';

      try{
        var res = await apiMarkVisited(place.id);
        if(!res || !res.ok){
          btn.disabled = false;
          btn.textContent = '‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
          showToast(res && res.message ? res.message : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
        await loadPlaces();
      }catch(err){
        console.error(err);
        btn.disabled = false;
        btn.textContent = '‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
        showToast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      }
    });
  }, true);

  async function loadPlaces(){ await doLoadPlaces_(); }

  async function doLoadPlaces_(){
    showLoading();
    try{
      var res = await apiGetPlaces();
      if(!res || !res.ok){
        console.error('getPlaces failed:', res);
        $('badge').textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        $('list').innerHTML =
          '<div class="center">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><span class="warn">' +
          escapeHtml(res && res.message ? res.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏') +
          '</span></div>';
        return;
      }

      META = {
        total: (res && res.total) ? res.total : 0,
        visited: (res && res.visited) ? res.visited : 0,
        remaining: (res && res.remaining) ? res.remaining : 0
      };
      PLACES = (res && res.places) ? res.places.filter(function(p){ return p && p.id && p.name; }) : [];
      renderList();
      if(map) renderMap();
    }catch(err){
      console.error(err);
      $('badge').textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
      $('list').innerHTML =
        '<div class="center">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><span class="warn">' + escapeHtml(err && err.message ? err.message : String(err)) + '</span></div>';
    }
  }

  function requestGPS(){
    if(!navigator.geolocation){
      $('gpsPill').textContent = 'GPS: ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
      return;
    }
    $('gpsPill').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤ GPS‚Ä¶';
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      if(map) setCurrentLocation(lat, lng);
      else currentLatLng = {lat:lat, lng:lng};
      $('gpsPill').textContent = 'GPS: ‡∏û‡∏£‡πâ‡∏≠‡∏°';
      if($('sortMode').value === 'nearest'){ renderList(); }
      if(map) renderMap();
    }, function(err){
      console.warn(err);
      $('gpsPill').textContent = 'GPS: ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
      if(map) renderMap();
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:15000 });
  }

  async function onResetAll(){
    var ok = await openModal({
      title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
      body:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á visited ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)',
      okText:'‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
      cancelText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      danger:true
    });
    if(!ok) return;

    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‚Ä¶');

    try{
      var res = await apiResetVisitedAll();
      if(!res || !res.ok){
        showToast(res && res.message ? res.message : '‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }
      showToast('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
      $('q').value = '';
      $('sortMode').value = 'default';
      await loadPlaces();
    }catch(err){
      console.error(err);
      showToast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á');
    }
  }

  function setPage(page){
    var isMap = (page === 'map');

    $('pageList').classList.toggle('active', !isMap);
    $('pageMap').classList.toggle('active', isMap);

    $('tabList').classList.toggle('active', !isMap);
    $('tabMap').classList.toggle('active', isMap);

    if(isMap){
      initMap();
      setTimeout(function(){
        try{ map.invalidateSize(); }catch(e){}
        renderMap();
      }, 60);
    }
  }

  function syncPageFromHash(){
    var h = (location.hash || '#list').toLowerCase();
    if(h === '#map') setPage('map');
    else setPage('list');
  }

  $('q').addEventListener('input', function(){ renderList(); if(map) renderMap(); });
  $('sortMode').addEventListener('change', function(){
    if($('sortMode').value === 'nearest' && !currentLatLng){
      showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏Å‡∏î GPS)');
    }
    renderList(); if(map) renderMap();
  });

  $('btnRefresh').onclick = function(){ loadPlaces(); requestGPS(); showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß'); };
  $('btnResetAll').onclick = onResetAll;
  $('gpsPill').onclick = requestGPS;

  $('tabList').onclick = function(){ location.hash = '#list'; };
  $('tabMap').onclick = function(){ location.hash = '#map'; };
  window.addEventListener('hashchange', syncPageFromHash);

  // ===== Boot =====
  setTimeout(function(){
    tryFullscreenOnOpen();
  }, 120);

  loadPlaces();
  requestGPS();
  syncPageFromHash();
</script>
</body>
</html>
